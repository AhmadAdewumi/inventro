<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventro OS</title>
    
    <!-- CORE LIBRARIES -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- TOAST NOTIFICATIONS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- CONFIG -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
                        slate: { 850: '#1e293b', 900: '#0f172a' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(5px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .scroller::-webkit-scrollbar { width: 6px; height: 6px; }
        .scroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        body { background-color: #f8fafc; }
        /* Scanner Fixes */
        #reader { border: none !important; }
        #reader__scan_region { background: white; }
        #reader__dashboard_section_csr span { display: none; }
        #reader__dashboard_section_swaplink { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, Component } = React;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("React Error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-10 flex flex-col items-center justify-center h-screen text-center">
                            <h1 className="text-3xl font-bold text-red-600 mb-4">System Error</h1>
                            <p className="text-slate-600 mb-4">Something went wrong while rendering the interface.</p>
                            <pre className="bg-slate-100 p-4 rounded text-left text-xs font-mono overflow-auto max-w-2xl border border-red-200 text-red-800">
                                {this.state.error && this.state.error.toString()}
                            </pre>
                            <button onClick={() => window.location.reload()} className="mt-6 px-6 py-2 bg-slate-800 text-white rounded hover:bg-slate-700">Reload Page</button>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        // --- UTILS ---
        const notify = (msg, type='success') => {
            Toastify({ text: msg, duration: 3000, gravity: "top", position: "right", className: type === 'error' ? "bg-red-500" : "bg-emerald-500", style: { borderRadius: "8px", boxShadow: "0 4px 6px rgba(0,0,0,0.1)", fontWeight: "bold" } }).showToast();
        };

        const api = {
            get: async (endpoint) => {
                const res = await fetch(`/api/${endpoint}`);
                if (res.status === 401) window.location.href = '/login/';
                const text = await res.text();
                try { return JSON.parse(text); } catch { console.error("API Error Text:", text); throw new Error("Server Error (Invalid JSON)"); }
            },
            post: async (endpoint, body) => {
                const res = await fetch(`/api/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }, body: JSON.stringify(body) });
                const text = await res.text();
                try {
                    const json = JSON.parse(text);
                    if (!res.ok) throw new Error(json.error || 'Request failed');
                    return json;
                } catch { console.error("API Error Text:", text); throw new Error("Server Error (Invalid JSON)"); }
            },
            download: (endpoint) => window.location.href = `/api/${endpoint}`
        };

        function getCookie(name) { let v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)'); return v ? v[2] : null; }
        
        const CountUp = ({ end, prefix = "" }) => { 
            const [count, setCount] = useState(0); 
            useEffect(() => { 
                let start = 0; const step = end / 60; 
                const timer = setInterval(() => { 
                    start += step; 
                    if (start >= end) { setCount(end); clearInterval(timer); } else setCount(start); 
                }, 16); 
                return () => clearInterval(timer); 
            }, [end]); 
            // Safety check for NaN
            const safeCount = isNaN(count) ? 0 : count;
            return <span>{prefix}{new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(safeCount)}</span>; 
        };
        
        const formatCurrency = (n) => {
            if (n === undefined || n === null || isNaN(n)) return "$0.00";
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n);
        };

        const formatDate = (d) => {
            try { return new Date(d).toLocaleDateString() + ' ' + new Date(d).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }
            catch { return "Invalid Date"; }
        };

        // --- COMPONENTS ---
        const Card = ({ children, className = "", noBg=false }) => <div className={`rounded-xl shadow-sm border border-slate-200 p-6 ${noBg ? '' : 'bg-white'} ${className}`}>{children}</div>;
        const DarkCard = ({ children, className = "" }) => <div className={`rounded-xl shadow-sm border border-slate-800 p-6 bg-slate-900 text-white ${className}`}>{children}</div>;
        
        const Button = ({ children, onClick, variant="primary", className="", disabled=false, ...props }) => {
            const styles = {
                primary: "bg-brand-600 text-white hover:bg-brand-500 shadow-md",
                ghost: "bg-transparent text-slate-600 hover:bg-slate-100",
                danger: "bg-red-500 text-white hover:bg-red-400 shadow-md",
                success: "bg-emerald-600 text-white hover:bg-emerald-500 shadow-md",
                purple: "bg-purple-600 text-white hover:bg-purple-500 shadow-md",
                dark: "bg-slate-800 text-white hover:bg-slate-700 shadow-md"
            };
            return <button type={props.type || "button"} onClick={onClick} disabled={disabled} className={`px-4 py-2 rounded-lg font-medium transition-all active:scale-95 flex items-center justify-center gap-2 ${styles[variant]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`} {...props}>{children}</button>;
        };
        const Input = ({ label, className="", ...props }) => ( <div className={`flex flex-col gap-1 ${className}`}><label className="text-xs font-bold text-slate-500 uppercase tracking-wide">{label}</label><input className="w-full p-2.5 rounded-lg border border-slate-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition-all" {...props} /></div> );
        const StatusBadge = ({ status }) => { const styles = { completed: "bg-emerald-100 text-emerald-700 border-emerald-200", refunded: "bg-red-100 text-red-700 border-red-200", pending: "bg-amber-100 text-amber-700 border-amber-200", received: "bg-blue-100 text-blue-700 border-blue-200", draft: "bg-slate-100 text-slate-600" }; return <span className={`px-2.5 py-0.5 rounded-full text-xs font-bold uppercase border border-opacity-20 ${styles[status] || styles.draft}`}>{status}</span>; };
        
        const Pagination = ({ total, page, setPage, perPage=10 }) => {
            const pages = Math.ceil(total / perPage);
            if (pages <= 1) return null;
            return (
                <div className="flex justify-center gap-4 mt-4 items-center bg-slate-50 p-2 rounded-lg inline-flex mx-auto">
                    <button disabled={page===1} onClick={()=>setPage(p=>p-1)} className="p-1 rounded hover:bg-white disabled:opacity-30 text-slate-600 transition"><i className="ph ph-caret-left text-lg"></i></button>
                    <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Page {page} of {pages}</span>
                    <button disabled={page===pages} onClick={()=>setPage(p=>p+1)} className="p-1 rounded hover:bg-white disabled:opacity-30 text-slate-600 transition"><i className="ph ph-caret-right text-lg"></i></button>
                </div>
            )
        };

        // --- CAMERA COMPONENT ---
        const CameraModal = ({ onScan, onClose }) => {
            useEffect(() => {
                let scanner = null;
                
                const initScanner = () => {
                    try {
                        const config = { 
                            fps: 20, 
                            qrbox: { width: 280, height: 150 }, 
                            aspectRatio: 1.0,
                            showTorchButtonIfSupported: true,
                            experimentalFeatures: { useBarCodeDetectorIfSupported: true }
                        };

                        scanner = new Html5QrcodeScanner("reader", config, false);
                        
                        scanner.render((txt) => { 
                            scanner.clear(); 
                            onScan(txt); 
                        }, (err) => { });
                    } catch (e) { console.error("Scanner Error:", e); }
                };

                const timer = setTimeout(initScanner, 200);

                return () => { 
                    clearTimeout(timer);
                    try { if(scanner) scanner.clear(); } catch(e){} 
                };
            }, []);

            return (
                <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl overflow-hidden w-full max-w-sm animate-fade-in relative shadow-2xl">
                        <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-slate-700 flex items-center gap-2"><i className="ph ph-scan text-brand-600"></i> Scan Barcode</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><i className="ph ph-x text-lg"></i></button>
                        </div>
                        <div className="p-0 bg-black relative min-h-[300px]">
                            <div id="reader" className="w-full h-full"></div>
                            <div className="absolute bottom-4 left-0 right-0 text-center text-white/80 text-xs pointer-events-none font-bold z-10">
                                Hold camera steady on barcode
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- PAGES ---

        const Dashboard = ({ onNavigate }) => {
            const [stats, setStats] = useState(null);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Effect 1: Fetch Data
            useEffect(() => { 
                api.get('reports/dashboard/').then(data => {
                    setStats(data);
                }); 
            }, []);

            // Effect 2: Render Chart (Only when stats is loaded)
            useEffect(() => {
                if (stats && chartRef.current && typeof Chart !== 'undefined') {
                    // Destroy previous instance to avoid glitches
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    // Create new chart
                    chartInstance.current = new Chart(chartRef.current, {
                        type: 'line',
                        data: {
                            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                            datasets: [{
                                label: 'Revenue',
                                // Use today's revenue as the last point
                                data: [1200, 1500, 900, 1400, 1100, 800, stats.revenue || 0], 
                                borderColor: '#2563eb', 
                                backgroundColor: (ctx) => {
                                    const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 200);
                                    gradient.addColorStop(0, 'rgba(37, 99, 235, 0.2)');
                                    gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');
                                    return gradient;
                                },
                                fill: true, 
                                tension: 0.4, 
                                pointRadius: 4, 
                                pointHoverRadius: 6
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false,
                            plugins: { legend: {display: false} }, 
                            scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } } 
                        }
                    });
                }

                return () => {
                    if (chartInstance.current) chartInstance.current.destroy();
                };
            }, [stats]); // Re-run when stats are loaded

            if (!stats) return <div className="p-10 text-slate-400 flex items-center gap-2"><i className="ph ph-spinner animate-spin"></i> Loading...</div>;

            return (
                <div className="space-y-6 animate-fade-in h-full flex flex-col pb-4">
                    <header className="flex justify-between items-end"><div><h1 className="text-3xl font-bold text-slate-800 tracking-tight">Overview</h1><p className="text-slate-500">Store performance for {stats.date}</p></div></header>
                    <div className="grid grid-cols-3 gap-6">
                        <Card className="border-l-4 border-l-emerald-500 group hover:-translate-y-1 transition-transform duration-300"><div className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Revenue</div><div className="text-4xl font-bold text-slate-800"><CountUp end={stats.revenue || 0} prefix="$" /></div></Card>
                        <Card className={`border-l-4 ${stats.profit>=0?'border-l-brand-500':'border-l-red-500'} group hover:-translate-y-1 transition-transform duration-300`}><div className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Net Profit</div><div className={`text-4xl font-bold ${stats.profit>=0?'text-brand-600':'text-red-600'}`}><CountUp end={stats.profit || 0} prefix="$" /></div></Card>
                        <Card className="border-l-4 border-l-orange-500 group hover:-translate-y-1 transition-transform duration-300"><div className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Low Stock</div><div className="text-4xl font-bold text-orange-500">{stats.low_stock_items || 0}</div></Card>
                    </div>
                    <div className="grid grid-cols-3 gap-6 flex-grow">
                        <Card className="col-span-2 flex flex-col min-h-[300px]"><h3 className="font-bold text-slate-700 mb-4">Revenue Trend</h3><div className="flex-grow relative"><canvas ref={chartRef}></canvas></div></Card>
                        <DarkCard className="flex flex-col justify-center gap-4 relative overflow-hidden">
                            <h3 className="font-bold text-slate-300 z-10">Quick Actions</h3>
                            <button onClick={()=>onNavigate('inventory', true)} className="w-full text-left p-4 rounded-xl bg-white/10 hover:bg-white/20 transition flex items-center gap-3 z-10 cursor-pointer"><i className="ph ph-plus-circle text-2xl text-brand-400"></i> <span className="font-medium">Add Product</span></button>
                            <button onClick={()=>onNavigate('procurement', true)} className="w-full text-left p-4 rounded-xl bg-white/10 hover:bg-white/20 transition flex items-center gap-3 z-10 cursor-pointer"><i className="ph ph-truck text-2xl text-emerald-400"></i> <span className="font-medium">Create Purchase Order</span></button>
                            <button onClick={()=>api.download('print-labels/')} className="w-full text-left p-4 rounded-xl bg-white/10 hover:bg-white/20 transition flex items-center gap-3 z-10 cursor-pointer"><i className="ph ph-printer text-2xl text-orange-400"></i> <span className="font-medium">Print Labels</span></button>
                            <i className="ph ph-lightning absolute -bottom-6 -right-6 text-9xl opacity-5"></i>
                        </DarkCard>
                    </div>
                </div>
            );
        };

        const InventoryManager = ({ openModalOnLoad }) => {
            const [products, setProducts] = useState([]);
            const [selected, setSelected] = useState([]);
            const [search, setSearch] = useState("");
            const [showModal, setShowModal] = useState(openModalOnLoad || false);
            const [page, setPage] = useState(1);
            const PER_PAGE = 10;
            
            useEffect(() => { loadProducts(); }, [search]);

            const loadProducts = () => {
                const query = search ? `?search=${search}` : '';
                api.get(`products/${query}`).then(res => { setProducts(res); setPage(1); setSelected([]); });
            }

            const paginatedProducts = useMemo(() => {
                const start = (page - 1) * PER_PAGE;
                return products.slice(start, start + PER_PAGE);
            }, [products, page]);

            const toggleSelect = (id) => setSelected(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
            const toggleAll = () => setSelected(prev => prev.length === products.length ? [] : products.map(p => p.id));

            const handlePrint = () => {
                const query = selected.length > 0 ? `?ids=${selected.join(',')}` : '';
                api.download(`print-labels/${query}`);
                notify(selected.length > 0 ? `Downloading ${selected.length} Labels...` : "Downloading All Labels...");
            };

            const AddProductModal = () => {
                const [form, setForm] = useState({ name: '', category: '', price: '', cost: '', stock: '', barcode: '', sku: '' });
                const [loading, setLoading] = useState(false);
                const [showCamera, setShowCamera] = useState(false);

                const handleSubmit = async (e) => {
                    e.preventDefault(); setLoading(true);
                    try { await api.post('products/', form); setShowModal(false); loadProducts(); notify("Product Created!"); } 
                    catch(err) { notify(err.message, 'error'); } finally { setLoading(false); }
                };

                return (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in">
                        {showCamera && <CameraModal onScan={(code)=>{setForm({...form, barcode: code}); setShowCamera(false); notify("Scanned!");}} onClose={()=>setShowCamera(false)} />}
                        <div className="bg-white p-8 rounded-2xl w-96 shadow-2xl">
                            <h2 className="text-2xl font-bold mb-6 text-slate-800">New Product</h2>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <Input label="Name" required onChange={e=>setForm({...form, name: e.target.value})} placeholder="e.g. Nike Shirt" />
                                <div className="grid grid-cols-2 gap-3"><Input label="Category" required onChange={e=>setForm({...form, category: e.target.value})} /><Input label="SKU" required onChange={e=>setForm({...form, sku: e.target.value})} /></div>
                                <div className="grid grid-cols-2 gap-3"><Input label="Sell Price" type="number" required onChange={e=>setForm({...form, price: e.target.value})} /><Input label="Cost Price" type="number" required onChange={e=>setForm({...form, cost: e.target.value})} /></div>
                                <div className="grid grid-cols-2 gap-3">
                                    <Input label="Stock" type="number" required onChange={e=>setForm({...form, stock: e.target.value})} />
                                    <div className="flex items-end gap-2">
                                        <Input label="Barcode" required value={form.barcode} onChange={e=>setForm({...form, barcode: e.target.value})} className="flex-grow" />
                                        <Button variant="dark" onClick={()=>setShowCamera(true)} className="px-3"><i className="ph ph-camera text-xl"></i></Button>
                                    </div>
                                </div>
                                <div className="flex gap-3 mt-6 pt-2"><Button type="button" variant="ghost" className="w-full" onClick={()=>setShowModal(false)}>Cancel</Button><Button type="submit" disabled={loading} className="w-full">Create</Button></div>
                            </form>
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-full flex flex-col gap-6 animate-fade-in">
                    {showModal && <AddProductModal />}
                    <div className="flex justify-between items-center"><h1 className="text-2xl font-bold text-slate-800">Inventory</h1>
                        <div className="flex gap-3"><div className="relative"><i className="ph ph-magnifying-glass absolute left-3 top-3 text-slate-400"></i><input placeholder="Search products..." className="pl-10 pr-4 py-2 rounded-lg border border-slate-200 outline-none focus:border-brand-500 w-64 transition-all" value={search} onChange={e=>setSearch(e.target.value)} /></div>
                        <Button variant="dark" onClick={handlePrint} disabled={products.length === 0}><i className="ph ph-printer"></i> {selected.length > 0 ? `Print (${selected.length})` : 'Print All'}</Button>
                        <Button onClick={()=>setShowModal(true)}><i className="ph ph-plus"></i> Add Product</Button></div>
                    </div>
                    <Card className="flex-grow p-0 overflow-hidden flex flex-col border-0 shadow-md">
                        <div className="overflow-auto scroller h-full">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-50 font-bold border-b text-slate-500 sticky top-0 z-10">
                                    <tr>
                                        <th className="p-4 w-10 text-center"><input type="checkbox" className="w-4 h-4 rounded cursor-pointer" onChange={toggleAll} checked={products.length > 0 && selected.length === products.length} /></th>
                                        <th className="p-4">Product</th><th className="p-4">SKU</th><th className="p-4">Barcode</th><th className="p-4 text-right">Cost</th><th className="p-4 text-right">Price</th><th className="p-4 text-right">Stock</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100 bg-white">
                                    {paginatedProducts.map(p=>(
                                        <tr key={p.id} className={`hover:bg-slate-50 transition-colors ${selected.includes(p.id) ? 'bg-blue-50' : ''}`}>
                                            <td className="p-4 text-center"><input type="checkbox" className="w-4 h-4 rounded cursor-pointer" checked={selected.includes(p.id)} onChange={()=>toggleSelect(p.id)} /></td>
                                            <td className="p-4 font-medium text-slate-700">{p.product_name} <span className="text-slate-400 text-xs block">{p.name_suffix}</span></td>
                                            <td className="p-4 font-mono text-xs text-slate-500">{p.sku}</td>
                                            <td className="p-4 font-mono text-xs bg-slate-50 w-min rounded px-2 py-1">{p.barcode}</td>
                                            <td className="p-4 text-right text-slate-400">${p.cost_price}</td>
                                            <td className="p-4 text-right font-bold text-slate-700">${p.price}</td>
                                            <td className={`p-4 text-right font-bold ${p.stock_quantity<10?'text-red-500':'text-emerald-600'}`}>{p.stock_quantity}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <div className="border-t p-2 bg-slate-50"><Pagination total={products.length} page={page} setPage={setPage} perPage={PER_PAGE} /></div>
                    </Card>
                </div>
            );
        };

        const Procurement = ({ openCreateOnLoad }) => {
            const [pos, setPos] = useState([]);
            const [suppliers, setSuppliers] = useState([]);
            const [view, setView] = useState(openCreateOnLoad ? 'create_po' : 'list');

            useEffect(() => { loadData(); }, []);
            const loadData = () => { api.get('po/list/').then(setPos); api.get('suppliers/').then(setSuppliers); };

            const receivePO = async (id) => { if(!confirm("Receive stock? Values will be updated.")) return; try { await api.post(`po/${id}/receive/`, {}); notify("Stock Received & Updated!"); loadData(); } catch(e){ notify(e.message, 'error'); } };

            const AddSupplierModal = ({ onClose }) => {
                const [form, setForm] = useState({ name: '', contact_person: '', email: '' });
                const submit = async (e) => { e.preventDefault(); try { await api.post('suppliers/', form); loadData(); onClose(); notify("Supplier Added"); } catch(e){ notify(e.message, 'error'); } };
                return (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50"><div className="bg-white p-6 rounded-xl w-96 animate-fade-in"><h2 className="text-xl font-bold mb-4">New Supplier</h2><form onSubmit={submit} className="space-y-3"><Input label="Company Name" required onChange={e=>setForm({...form, name: e.target.value})} /><Input label="Contact Person" onChange={e=>setForm({...form, contact_person: e.target.value})} /><Input label="Email" type="email" onChange={e=>setForm({...form, email: e.target.value})} /><div className="flex gap-2 mt-4"><Button type="button" variant="ghost" className="w-full" onClick={onClose}>Cancel</Button><Button type="submit" className="w-full">Save</Button></div></form></div></div>
                )
            };

            const CreatePO = () => {
                const [form, setForm] = useState({ supplier_id: '', items: [] });
                const [line, setLine] = useState({ variant_id: '', qty: '', cost: '' });
                const [variants, setVariants] = useState([]);
                // FIX: API now works, dropdown populates
                useEffect(() => { api.get('products/').then(setVariants); }, []);

                const addLine = () => {
                    if(!line.variant_id) return notify("Select a product", 'error');
                    setForm(p => ({...p, items: [...p.items, {variant_id: line.variant_id, quantity: parseInt(line.qty), cost: parseFloat(line.cost)}]}));
                    setLine({variant_id: '', qty: '', cost: ''});
                };
                const submit = async () => { try { await api.post('po/create/', form); notify("PO Created!"); setView('list'); loadData(); } catch(e){ notify(e.message, 'error'); } };

                return (
                    <div className="flex flex-col h-full gap-4 animate-fade-in">
                        <div className="flex items-center gap-2"><Button variant="ghost" onClick={()=>setView('list')}><i className="ph ph-arrow-left"></i> Back</Button><h2 className="text-xl font-bold">New Purchase Order</h2></div>
                        <Card className="flex-grow flex flex-col gap-4">
                            <div className="flex gap-4 items-end"><div className="flex-grow"><label className="text-xs font-bold uppercase text-slate-500">Supplier</label><select className="w-full p-2.5 bg-slate-50 border rounded-lg mt-1" onChange={e=>setForm({...form, supplier_id: e.target.value})}><option>Select Supplier</option>{suppliers.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}</select></div></div>
                            <div className="bg-slate-50 p-4 rounded-xl border grid grid-cols-4 gap-3 items-end">
                                <div className="col-span-2"><label className="text-xs font-bold uppercase text-slate-500">Product</label><select className="w-full p-2 border rounded mt-1" value={line.variant_id} onChange={e=>setLine({...line, variant_id: e.target.value})}><option>Select Product</option>{variants.map(v=><option key={v.id} value={v.id}>{v.product_name} ({v.sku})</option>)}</select></div>
                                <div><label className="text-xs font-bold uppercase text-slate-500">Qty</label><input type="number" className="w-full p-2 border rounded mt-1" value={line.qty} onChange={e=>setLine({...line, qty: e.target.value})} /></div>
                                <div><label className="text-xs font-bold uppercase text-slate-500">Unit Cost</label><input type="number" className="w-full p-2 border rounded mt-1" value={line.cost} onChange={e=>setLine({...line, cost: e.target.value})} /></div>
                                <Button onClick={addLine} variant="dark" className="col-span-4 mt-2">Add Line Item</Button>
                            </div>
                            <div className="flex-grow overflow-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-50 text-slate-500"><tr><th className="p-3">Item ID</th><th className="p-3">Qty</th><th className="p-3">Cost</th></tr></thead><tbody>{form.items.map((i,idx)=><tr key={idx} className="border-b"><td className="p-3">{i.variant_id}</td><td className="p-3">{i.quantity}</td><td className="p-3">${i.cost}</td></tr>)}</tbody></table></div>
                            <Button onClick={submit} className="w-full py-3">Confirm & Create PO</Button>
                        </Card>
                    </div>
                );
            };

            if(view === 'create_po') return <CreatePO />;

            return (
                <div className="h-full flex flex-col gap-6 animate-fade-in">
                    {view === 'add_supplier' && <AddSupplierModal onClose={()=>setView('list')} />}
                    <div className="flex justify-between items-center"><h1 className="text-2xl font-bold text-slate-800">Procurement</h1>
                        <div className="flex gap-2"><Button variant="ghost" onClick={()=>setView('add_supplier')}><i className="ph ph-user-plus"></i> New Supplier</Button><Button onClick={()=>setView('create_po')}><i className="ph ph-plus"></i> New PO</Button></div>
                    </div>
                    <Card className="flex-grow p-0 overflow-hidden flex flex-col border-0 shadow-md"><div className="overflow-auto scroller"><table className="w-full text-left text-sm"><thead className="bg-slate-50 font-bold border-b sticky top-0 text-slate-500"><tr><th className="p-4">PO #</th><th className="p-4">Supplier</th><th className="p-4">Status</th><th className="p-4 text-right">Total Cost</th><th className="p-4"></th></tr></thead><tbody className="divide-y divide-slate-100">{pos.map(p=><tr key={p.id} className="hover:bg-slate-50 transition-colors"><td className="p-4 font-mono font-bold text-brand-600">#{p.id}</td><td className="p-4 font-medium">{p.supplier_name}</td><td className="p-4"><StatusBadge status={p.status}/></td><td className="p-4 text-right font-mono text-slate-600 font-bold">{formatCurrency(p.total_cost)}</td><td className="p-4 text-right">{p.status==='draft' && <Button size="sm" variant="success" onClick={()=>receivePO(p.id)} className="text-xs py-1">Receive Stock</Button>}</td></tr>)}</tbody></table></div></Card>
                </div>
            );
        };

        const AuditLogs = () => {
            const [logs, setLogs] = useState([]);
            useEffect(() => { api.get('logs/').then(setLogs); }, []);
            return (
                <div className="h-full flex flex-col gap-4 animate-fade-in"><h1 className="text-2xl font-bold text-slate-800">Audit Trail</h1><Card className="flex-grow p-0 overflow-hidden flex flex-col border-0 shadow-md"><div className="overflow-auto scroller"><table className="w-full text-left text-sm"><thead className="bg-slate-50 font-bold border-b sticky top-0 text-slate-500"><tr><th className="p-4">Time</th><th className="p-4">Action</th><th className="p-4">User</th><th className="p-4">Product</th><th className="p-4 text-right">Change</th><th className="p-4">Note</th></tr></thead><tbody className="divide-y divide-slate-100">{logs.map(l=><tr key={l.id} className="hover:bg-slate-50"><td className="p-4 text-slate-400 text-xs font-mono">{formatDate(l.created_at)}</td><td className="p-4 uppercase font-bold text-xs tracking-wider">{l.action}</td><td className="p-4"><span className="bg-slate-100 px-2 py-1 rounded text-xs font-bold">{l.user_name}</span></td><td className="p-4 font-medium">{l.product_name}</td><td className={`p-4 text-right font-mono font-bold ${l.quantity_change>0?'text-emerald-600':'text-red-500'}`}>{l.quantity_change>0?'+':''}{l.quantity_change}</td><td className="p-4 text-slate-500 italic text-xs">{l.note}</td></tr>)}</tbody></table></div></Card></div>
            );
        };

        const PosTerminal = () => {
            const [input, setInput] = useState("");
            // FIX: scanQty persists until manually changed
            const [scanQty, setScanQty] = useState(1);
            const [cart, setCart] = useState(() => { try { return JSON.parse(localStorage.getItem('pos_cart')) || [] } catch { return [] } });
            const [loading, setLoading] = useState(false);
            const [showCamera, setShowCamera] = useState(false);
            const inputRef = useRef(null);

            useEffect(() => { localStorage.setItem('pos_cart', JSON.stringify(cart)); }, [cart]);
            useEffect(() => { 
                const keepFocus = (e) => { 
                    if(document.activeElement.tagName !== 'INPUT' && !showCamera) inputRef.current?.focus(); 
                };
                document.addEventListener('click', keepFocus); inputRef.current?.focus();
                return () => document.removeEventListener('click', keepFocus);
            }, [showCamera]);

            const handleScan = async (code) => {
                if(!code) return;
                setLoading(true);
                try {
                    const p = await api.get(`scan/${code}/`);
                    setCart(prev => {
                        const ex = prev.find(x => x.barcode === p.barcode);
                        // Add scanQty instead of just 1
                        return ex ? prev.map(x => x.barcode === p.barcode ? {...x, qty: x.qty + scanQty} : x) : [...prev, {...p, qty: scanQty}];
                    });
                    setInput("");
                    // FIX: Don't reset scanQty here, let user keep scanning 5s if they want
                } catch(e) { notify("Product Not Found", 'error'); } 
                finally { setLoading(false); setTimeout(()=>inputRef.current?.focus(), 50); }
            };

            const updateQty = (barcode, newQty) => {
                if (newQty < 1) return;
                setCart(cart.map(item => item.barcode === barcode ? { ...item, qty: parseInt(newQty) } : item));
            };

            const checkout = async (method) => {
                if(!cart.length) return;
                setLoading(true);
                try {
                    const res = await api.post('purchase/', { payment_method: method, items: cart.map(i=>({barcode:i.barcode, quantity:i.qty})) });
                    notify(`Order #${res.order_id} Paid (${method.toUpperCase()}): ${formatCurrency(res.total)}`);
                    setCart([]);
                } catch(e) { notify(e.message, 'error'); } finally { setLoading(false); }
            };

            const total = cart.reduce((a,b)=>a+(b.price*b.qty),0);

            return (
                <div className="h-full flex gap-6 animate-fade-in">
                    {showCamera && <CameraModal onScan={(code)=>{setShowCamera(false); handleScan(code); notify("Scanned!");}} onClose={()=>setShowCamera(false)} />}
                    <div className="flex-grow flex flex-col gap-4">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex gap-4 items-center ring-4 ring-slate-50 transition-all focus-within:ring-brand-100 focus-within:border-brand-300">
                            <div className="flex flex-col gap-1 w-24">
                                <label className="text-xs font-bold text-slate-400 uppercase">QTY</label>
                                <input type="number" min="1" value={scanQty} onChange={e => setScanQty(Math.max(1, parseInt(e.target.value) || 1))} className="w-full text-xl font-bold text-center outline-none border-b-2 border-brand-500 focus:bg-slate-50" />
                            </div>
                            <div className="h-10 w-px bg-slate-200 mx-2"></div>
                            <i className="ph ph-barcode text-4xl text-slate-300"></i>
                            <input ref={inputRef} value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleScan(input.trim())} className="w-full text-2xl outline-none font-mono placeholder:text-slate-300" placeholder="Scan item barcode..." autoFocus />
                            <Button variant="dark" onClick={()=>setShowCamera(true)} className="px-4 h-12"><i className="ph ph-camera text-xl"></i> Scan</Button>
                        </div>
                        <Card className="flex-grow p-0 overflow-hidden flex flex-col border-0 shadow-md">
                            <div className="p-4 bg-slate-50 border-b font-bold text-xs text-slate-500 uppercase flex tracking-wider">
                                <span className="flex-grow">Item</span><span className="w-32 text-center">Qty</span><span className="w-24 text-right">Price</span><span className="w-10"></span>
                            </div>
                            <div className="flex-grow overflow-auto p-2 space-y-1 bg-white">
                                {cart.map(i => (
                                    <div key={i.barcode} className="flex items-center p-3 hover:bg-slate-50 rounded-lg group transition-colors">
                                        <div className="flex-grow font-bold text-slate-700">{i.product_name} <span className="block text-xs text-slate-400 font-normal">{i.sku}</span></div>
                                        <div className="w-32 flex items-center justify-center gap-2">
                                            <button onClick={() => updateQty(i.barcode, i.qty - 1)} className="w-6 h-6 flex items-center justify-center bg-slate-100 rounded hover:bg-slate-200 text-slate-600">-</button>
                                            <span className="w-8 text-center font-bold">{i.qty}</span>
                                            <button onClick={() => updateQty(i.barcode, i.qty + 1)} className="w-6 h-6 flex items-center justify-center bg-slate-100 rounded hover:bg-slate-200 text-slate-600">+</button>
                                        </div>
                                        <div className="w-24 text-right font-mono text-slate-600">${(i.price*i.qty).toFixed(2)}</div>
                                        <button onClick={()=>setCart(cart.filter(x=>x.barcode!==i.barcode))} className="w-10 text-slate-300 hover:text-red-500"><i className="ph ph-trash text-xl"></i></button>
                                    </div>
                                ))}
                            </div>
                        </Card>
                    </div>
                    <div className="w-80 flex flex-col gap-4">
                        <Card className="bg-slate-900 text-white border-none shadow-2xl relative overflow-hidden">
                            <div className="relative z-10">
                                <div className="text-slate-400 text-xs font-bold uppercase tracking-widest">Total Due</div>
                                <div className="text-5xl font-mono font-bold mt-2 tracking-tight">{formatCurrency(total)}</div>
                            </div>
                            <div className="grid grid-cols-2 gap-2 mt-8 relative z-10">
                                <Button onClick={()=>checkout('cash')} disabled={!cart.length || loading} className="col-span-2 py-4 text-lg bg-emerald-600 hover:bg-emerald-500 shadow-lg shadow-emerald-900/50">CASH</Button>
                                <Button onClick={()=>checkout('card')} disabled={!cart.length || loading} className="py-3 bg-blue-600 hover:bg-blue-500">CARD</Button>
                                <Button onClick={()=>checkout('transfer')} disabled={!cart.length || loading} className="py-3 bg-purple-600 hover:bg-purple-500">TRANSFER</Button>
                            </div>
                            <i className="ph ph-receipt absolute -bottom-6 -right-6 text-9xl text-white opacity-5"></i>
                        </Card>
                    </div>
                </div>
            );
        };

        const OrderHistory = () => {
            const [orders, setOrders] = useState([]);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [filter, setFilter] = useState('all');
            
            useEffect(() => { loadOrders(); }, [filter]);
            const loadOrders = () => { const q = filter!=='all'?`?status=${filter}`:''; api.get(`orders/${q}`).then(setOrders); };

            const FilterTab = ({ id, label }) => <button onClick={() => setFilter(id)} className={`px-3 py-1 text-sm font-medium rounded-full transition-all ${filter===id ? 'bg-brand-600 text-white shadow' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>{label}</button>;

            const RefundPanel = ({ order, onClose }) => {
                const [refundData, setRefundData] = useState({});
                const [loading, setLoading] = useState(false);

                useEffect(() => {
                    const initial = {};
                    order.items.forEach(i => initial[i.id] = { qty: 0, damaged: false });
                    setRefundData(initial);
                }, [order]);

                const handleQty = (id, v, max) => setRefundData(p => ({...p, [id]: {...p[id], qty: Math.min(Math.max(0, parseInt(v)||0), max)}}));
                const toggleDmg = (id) => setRefundData(p => ({...p, [id]: {...p[id], damaged: !p[id].damaged}}));

                const submit = async () => {
                    const items = order.items.map(i => ({ barcode: i.barcode, quantity: refundData[i.id]?.qty||0, is_damaged: refundData[i.id]?.dmg||false })).filter(i=>i.quantity>0);
                    if(!items.length) return notify("Select items to return", 'error');
                    setLoading(true);
                    try { await api.post('refund/', { order_id: order.id, items }); notify("Refund Processed"); onClose(); } catch(e) { notify(e.message, 'error'); } finally { setLoading(false); }
                };

                const estTotal = order.items.reduce((a, i) => a + (parseFloat(i.unit_price) * (refundData[i.id]?.qty||0)), 0);

                return (
                    <Card className="h-full flex flex-col border-l-4 border-l-brand-500 animate-fade-in shadow-xl">
                        <div className="flex justify-between items-start mb-4 border-b pb-4">
                            <div><h2 className="text-xl font-bold">Order #{order.id}</h2><p className="text-sm text-slate-500">{formatDate(order.created_at)}</p></div>
                            <Button variant="ghost" onClick={()=>onClose(true)}><i className="ph ph-x text-lg"></i></Button>
                        </div>
                        <div className="flex-grow overflow-auto space-y-3">
                            {order.items.map(item => {
                                const eligible = item.quantity - item.refunded_quantity;
                                const cur = refundData[item.id] || {qty:0};
                                return (
                                    <div key={item.id} className={`p-4 rounded-lg border transition-all ${eligible>0 ? 'bg-white border-slate-200' : 'bg-slate-50 border-slate-100 opacity-60'}`}>
                                        <div className="flex justify-between mb-1"><span className="font-bold text-slate-700">{item.product_name}</span><span className="font-mono text-slate-500">${item.unit_price}</span></div>
                                        <div className="text-xs text-slate-400 mb-3 flex gap-3"><span>Bought: <b className="text-slate-700">{item.quantity}</b></span><span>Returned: <b className="text-red-500">{item.refunded_quantity}</b></span></div>
                                        {eligible > 0 && <div className="flex items-center gap-3 bg-slate-50 p-2 rounded border border-slate-100">
                                            <div className="flex items-center gap-2"><label className="text-[10px] font-bold uppercase text-slate-400">Return</label><input type="number" min="0" max={eligible} value={cur.qty} onChange={e=>handleQty(item.id, e.target.value, eligible)} className="w-16 p-1 text-center font-bold border rounded outline-none focus:border-brand-500" /></div>
                                            <div className="flex-grow"></div>
                                            <label className="flex items-center gap-2 cursor-pointer select-none"><input type="checkbox" checked={cur.dmg} onChange={()=>toggleDmg(item.id)} className="w-4 h-4 rounded text-red-600 focus:ring-red-500"/><span className={`text-xs font-bold uppercase ${cur.dmg?'text-red-600':'text-slate-400'}`}>Damaged</span></label>
                                        </div>}
                                    </div>
                                )
                            })}
                        </div>
                        <div className="pt-4 border-t mt-auto">
                            <div className="flex justify-between mb-4"><span className="font-bold text-slate-500">Refund Total</span><span className="text-2xl font-bold text-red-600">{formatCurrency(estTotal)}</span></div>
                            <Button onClick={submit} disabled={estTotal<=0||loading} variant="danger" className="w-full py-3 shadow-lg shadow-red-500/20">{loading?'Processing...':'Confirm Refund'}</Button>
                        </div>
                    </Card>
                );
            };

            return (
                <div className="h-full flex gap-6 animate-fade-in">
                    <div className={`${selectedOrder?'w-1/2':'w-full'} transition-all duration-300 flex flex-col gap-4`}>
                        <div className="flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-slate-800">Orders</h1>
                            <div className="flex gap-2"><FilterTab id="all" label="All"/><FilterTab id="completed" label="Completed"/><FilterTab id="refunded" label="Refunded"/><FilterTab id="pending" label="Pending"/></div>
                        </div>
                        <Card className="flex-grow p-0 overflow-hidden flex flex-col border-0 shadow-md">
                            <div className="overflow-auto scroller">
                                <table className="w-full text-left text-sm"><thead className="bg-slate-50 font-bold border-b sticky top-0 text-slate-500"><tr><th className="p-4">ID</th><th className="p-4">Date</th><th className="p-4">Cashier</th><th className="p-4">Status</th><th className="p-4 text-right">Total</th></tr></thead><tbody className="divide-y divide-slate-100">{orders.map(o => (<tr key={o.id} className={`hover:bg-slate-50 cursor-pointer transition-colors ${selectedOrder?.id===o.id?'bg-blue-50':''} ${o.status==='refunded'?'bg-red-50/50':''}`} onClick={()=>setSelectedOrder(o)}><td className="p-4 font-mono font-bold text-brand-600">#{o.id}</td><td className="p-4 text-slate-500">{new Date(o.created_at).toLocaleDateString()}</td><td className="p-4 font-medium">{o.cashier_name}</td><td className="p-4"><StatusBadge status={o.status}/></td><td className="p-4 text-right font-bold text-slate-700">{formatCurrency(o.total_amount)}</td></tr>))}</tbody></table>
                            </div>
                        </Card>
                    </div>
                    {selectedOrder && <div className="w-1/2 h-full"><RefundPanel order={selectedOrder} onClose={()=>{setSelectedOrder(null); loadOrders();}} /></div>}
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [modalParams, setModalParams] = useState(false);
            useEffect(() => { const v = localStorage.getItem('view'); if(v) setView(v); }, []);
            const nav = (v, params=false) => { setView(v); setModalParams(params); localStorage.setItem('view', v); };
            const NavItem = ({ id, icon, label }) => ( <button onClick={() => nav(id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl mb-1 transition-all ${view===id ? 'bg-brand-600 text-white shadow-lg shadow-brand-900/20' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}><i className={`ph ${icon} text-xl`}></i><span className="font-medium tracking-wide">{label}</span></button> );
            
            return (
                <div className="flex h-screen w-full bg-slate-100 font-sans text-slate-900">
                    <aside className="w-72 bg-slate-900 flex flex-col p-6 flex-shrink-0">
                        <div className="flex items-center gap-3 mb-10 px-2"><div className="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-500 to-indigo-600 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-brand-500/20">I</div><span className="text-2xl font-bold text-white tracking-tight">Inventro</span></div>
                        <nav className="flex-grow space-y-1">
                            <NavItem id="dashboard" icon="ph-chart-pie-slice" label="Dashboard" />
                            <NavItem id="pos" icon="ph-shopping-cart" label="POS Terminal" />
                            <NavItem id="orders" icon="ph-receipt" label="Orders & Refunds" />
                            <div className="pt-6 pb-2"><span className="text-xs font-bold uppercase text-slate-600 px-4 tracking-wider">Management</span></div>
                            <NavItem id="inventory" icon="ph-package" label="Inventory" />
                            <NavItem id="procurement" icon="ph-truck" label="Procurement" />
                            <NavItem id="audit" icon="ph-list-magnifying-glass" label="Audit Logs" />
                        </nav>
                        <div className="mt-auto pt-6 border-t border-slate-800"><a href="/logout/" className="flex items-center gap-3 px-4 py-2 text-red-400 hover:text-red-300 text-sm font-medium transition-colors"><i className="ph ph-sign-out text-lg"></i> Sign Out</a></div>
                    </aside>
                    <main className="flex-grow p-8 overflow-hidden h-full relative">
                        <ErrorBoundary>
                            {view==='dashboard' && <Dashboard onNavigate={nav}/>}
                            {view==='pos' && <PosTerminal/>}
                            {view==='orders' && <OrderHistory/>}
                            {view==='inventory' && <InventoryManager openModalOnLoad={modalParams}/>}
                            {view==='procurement' && <Procurement openCreateOnLoad={modalParams}/>}
                            {view==='audit' && <AuditLogs/>}
                        </ErrorBoundary>
                    </main>
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>