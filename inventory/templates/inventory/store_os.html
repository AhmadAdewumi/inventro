<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventro OS</title>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a'},
                        slate: {850: '#1e293b', 900: '#0f172a'}
                    },
                    animation: {'fade-in': 'fadeIn 0.3s ease-out'},
                    keyframes: {
                        fadeIn: {
                            '0%': {opacity: '0', transform: 'translateY(5px)'},
                            '100%': {opacity: '1', transform: 'translateY(0)'},
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .scroller::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .scroller::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        body {
            background-color: #f8fafc;
        }

        #reader video {
            object-fit: cover;
            width: 100%;
            height: 100%;
            border-radius: 0 0 1rem 1rem;
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .scroller::-webkit-scrollbar {
                width: 4px;
                height: 4px;
            }
        }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const {useState, useEffect, useRef, useMemo, Component} = React;

    // --- ERROR BOUNDARY ---
    class ErrorBoundary extends Component {
        constructor(props) {
            super(props);
            this.state = {hasError: false, error: null};
        }

        static getDerivedStateFromError(error) {
            return {hasError: true, error};
        }

        componentDidCatch(error, errorInfo) {
            console.error("React Error:", error, errorInfo);
        }

        render() {
            if (this.state.hasError) {
                return (
                    <div className="p-10 flex flex-col items-center justify-center h-screen text-center">
                        <h1 className="text-3xl font-bold text-red-600 mb-4">System Error</h1>
                        <p className="text-slate-600 mb-4">Something went wrong while rendering the interface.</p>
                        <pre
                            className="bg-slate-100 p-4 rounded text-left text-xs font-mono overflow-auto max-w-2xl border border-red-200 text-red-800">
                                {this.state.error && this.state.error.toString()}
                            </pre>
                        <button onClick={() => window.location.reload()}
                                className="mt-6 px-6 py-2 bg-slate-800 text-white rounded hover:bg-slate-700">Reload
                            Page
                        </button>
                    </div>
                );
            }
            return this.props.children;
        }
    }

    // --- UTILS ---
    const notify = (msg, type = 'success') => {
        Toastify({
            text: msg,
            duration: 3000,
            gravity: "top",
            position: "right",
            className: type === 'error' ? "bg-red-500" : "bg-emerald-500",
            style: {borderRadius: "8px", boxShadow: "0 4px 6px rgba(0,0,0,0.1)", fontWeight: "bold"}
        }).showToast();
    };

        const api = {
        // Central request handler to reuse logic
        request: async (endpoint, method = 'GET', body = null) => {
            const opts = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            };
            if (body) opts.body = JSON.stringify(body);

            const res = await fetch(`/api/${endpoint}`, opts);

            // Redirect on Auth Failure
            if (res.status === 401 || res.status === 403) window.location.href = '/login/';

            const text = await res.text();
            try {
                const json = JSON.parse(text);
                if (!res.ok) {
                    // 1. Check for explicit 'error' or 'detail' keys (General errors)
                    let errorMsg = json.error || json.detail;

                    // 2. If not found, check for Field Validation Errors (e.g. { "phone": ["Exists"] })
                    if (!errorMsg) {
                        const keys = Object.keys(json);
                        if (keys.length > 0) {
                            // Grab the first field error
                            const field = keys[0];
                            const message = Array.isArray(json[field]) ? json[field][0] : json[field];

                            // Format nicely: "Phone: This field must be unique."
                            errorMsg = `${field.charAt(0).toUpperCase() + field.slice(1)}: ${message}`;
                        } else {
                            errorMsg = 'Request failed';
                        }
                    }
                    throw new Error(errorMsg);
                }
                return json;
            } catch (e) {
                // Fallback for non-JSON errors (like 500 HTML pages)
                if (!res.ok) throw new Error(e.message || "Server Error");
                return text;
            }
        },

        // Shorthand methods
        get: (ep) => api.request(ep),
        post: (ep, body) => api.request(ep, 'POST', body),
        put: (ep, body) => api.request(ep, 'PUT', body),
        delete: (ep) => api.request(ep, 'DELETE'),
        download: (ep) => window.location.href = `/api/${ep}`
    };

    function getCookie(name) {
        let v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
        return v ? v[2] : null;
    }

    const CountUp = ({end, prefix = ""}) => {
        const [count, setCount] = useState(0);
        useEffect(() => {
            let start = 0;
            const step = end / 60;
            const timer = setInterval(() => {
                start += step;
                if (start >= end) {
                    setCount(end);
                    clearInterval(timer);
                } else setCount(start);
            }, 16);
            return () => clearInterval(timer);
        }, [end]);
        const safeCount = isNaN(count) ? 0 : count;
        return <span>{prefix}{new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(safeCount)}</span>;
    };

    const formatCurrency = (n) => {
        if (n === undefined || n === null || isNaN(n)) return "₦0.00";
        return new Intl.NumberFormat('en-NG', {style: 'currency', currency: 'NGN'}).format(n);
    };

    const formatDate = (d) => {
        try {
            return new Date(d).toLocaleDateString() + ' ' + new Date(d).toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch {
            return "Invalid Date";
        }
    };

    // --- COMPONENTS ---
    const Card = ({children, className = "", noBg = false}) => <div
        className={`rounded-xl shadow-sm border border-slate-200 p-6 ${noBg ? '' : 'bg-white'} ${className}`}>{children}</div>;
    const DarkCard = ({children, className = ""}) => <div
        className={`rounded-xl shadow-sm border border-slate-800 p-6 bg-slate-900 text-white ${className}`}>{children}</div>;

    const Button = ({children, onClick, variant = "primary", className = "", disabled = false, ...props}) => {
        const styles = {
            primary: "bg-brand-600 text-white hover:bg-brand-500 shadow-md",
            ghost: "bg-transparent text-slate-600 hover:bg-slate-100",
            danger: "bg-red-500 text-white hover:bg-red-400 shadow-md",
            success: "bg-emerald-600 text-white hover:bg-emerald-500 shadow-md",
            purple: "bg-purple-600 text-white hover:bg-purple-500 shadow-md",
            dark: "bg-slate-800 text-white hover:bg-slate-700 shadow-md"
        };
        return <button type={props.type || "button"} onClick={onClick} disabled={disabled}
                       className={`px-4 py-2 rounded-lg font-medium transition-all active:scale-95 flex items-center justify-center gap-2 ${styles[variant]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`} {...props}>{children}</button>;
    };
    const Input = ({label, className = "", ...props}) => (<div className={`flex flex-col gap-1 ${className}`}><label
        className="text-xs font-bold text-slate-500 uppercase tracking-wide">{label}</label><input
        className="w-full p-2.5 rounded-lg border border-slate-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition-all" {...props} />
    </div>);
    const StatusBadge = ({status}) => {
        const styles = {
            completed: "bg-emerald-100 text-emerald-700 border-emerald-200",
            refunded: "bg-red-100 text-red-700 border-red-200",
            pending: "bg-amber-100 text-amber-700 border-amber-200",
            received: "bg-blue-100 text-blue-700 border-blue-200",
            draft: "bg-slate-100 text-slate-600"
        };
        return <span
            className={`px-2.5 py-0.5 rounded-full text-xs font-bold uppercase border border-opacity-20 ${styles[status] || styles.draft}`}>{status}</span>;
    };

    const Pagination = ({total, page, setPage, perPage = 10}) => {
        const pages = Math.ceil(total / perPage);
        if (pages <= 1) return null;
        return (
            <div className="flex justify-center gap-4 mt-4 items-center bg-slate-50 p-2 rounded-lg inline-flex mx-auto">
                <button disabled={page === 1} onClick={() => setPage(p => p - 1)}
                        className="p-1 rounded hover:bg-white disabled:opacity-30 text-slate-600 transition"><i
                    className="ph ph-caret-left text-lg"></i></button>
                <span
                    className="text-xs font-bold text-slate-500 uppercase tracking-wider">Page {page} of {pages}</span>
                <button disabled={page === pages} onClick={() => setPage(p => p + 1)}
                        className="p-1 rounded hover:bg-white disabled:opacity-30 text-slate-600 transition"><i
                    className="ph ph-caret-right text-lg"></i></button>
            </div>
        )
    };

    // --- CAMERA COMPONENT ---
    const CameraModal = ({onScan, onClose}) => {
        const scannerRef = useRef(null);
        const [error, setError] = useState(null);

        const startScanner = () => {
            setError(null);

            // 1. Security Check
            const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            if (!isSecure) {
                setError("Browser restricted camera access. Please use HTTPS.");
                return;
            }

            // 2. Hardware API Check
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                setError("This browser does not support camera access.");
                return;
            }

            // Initialize if not already done
            if (!scannerRef.current) {
                scannerRef.current = new Html5Qrcode("reader");
            }

            const config = {fps: 10, qrbox: {width: 250, height: 150}, aspectRatio: 1.0};

            scannerRef.current.start({facingMode: "environment"}, config,
                (decodedText) => {
                    scannerRef.current.stop().then(() => {
                        scannerRef.current.clear();
                        onScan(decodedText);
                    }).catch(err => console.error("Stop failed", err));
                },
                (errorMessage) => {
                    // Scanning... ignore frame errors
                }
            ).catch(err => {
                console.error("Camera Start Error", err);
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    setError("Permission denied. Tap 'Retry' to allow camera access.");
                } else if (err.name === 'NotFoundError') {
                    setError("No camera device found on this device.");
                } else if (err.name === 'NotReadableError') {
                    setError("Camera is currently in use by another app.");
                } else if (err.name === 'OverconstrainedError') {
                    // Fallback to any camera if environment fails
                    scannerRef.current.start({facingMode: "user"}, config,
                        (decodedText) => {
                            scannerRef.current.stop().then(() => {
                                scannerRef.current.clear();
                                onScan(decodedText);
                            });
                        },
                        () => {
                        }
                    ).catch(() => setError("No suitable camera found."));
                } else {
                    setError(`Scanner Error: ${err.message || err}`);
                }
            });
        };

        useEffect(() => {
            // Initial start with delay to ensure DOM is ready
            const timer = setTimeout(() => startScanner(), 100);

            return () => {
                clearTimeout(timer);
                if (scannerRef.current) {
                    try {
                        scannerRef.current.stop().then(() => scannerRef.current.clear()).catch(() => {
                        });
                    } catch (e) {
                        console.error("Cleanup error", e);
                    }
                }
            };
        }, []);

        return (
            <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                <div
                    className="bg-white rounded-2xl overflow-hidden w-full max-w-sm animate-fade-in relative shadow-2xl">
                    <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                        <h3 className="font-bold text-slate-700 flex items-center gap-2">
                            <i className="ph ph-scan text-brand-600"></i> Scan Barcode
                        </h3>
                        <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors">
                            <i className="ph ph-x text-lg"></i>
                        </button>
                    </div>

                    <div className="p-0 bg-black relative h-[300px] flex items-center justify-center overflow-hidden">
                        <div id="reader" className="w-full h-full"></div>

                        {error ? (
                            <div
                                className="absolute inset-0 bg-black/90 text-center p-6 text-white flex flex-col items-center justify-center h-full z-20">
                                <div
                                    className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4 text-slate-400">
                                    <i className="ph ph-camera-slash text-3xl"></i>
                                </div>
                                <p className="text-sm font-medium mb-1 text-red-300">Scanner Error</p>
                                <p className="text-xs text-slate-300 mb-6 max-w-[200px] leading-relaxed break-words">{error}</p>
                                <div className="flex gap-2">
                                    <button onClick={startScanner}
                                            className="px-4 py-2 bg-brand-600 text-white text-sm rounded-full font-bold hover:bg-brand-500 transition-colors">
                                        Retry Camera
                                    </button>
                                    <button onClick={onClose}
                                            className="px-4 py-2 bg-white text-black text-sm rounded-full font-bold hover:bg-slate-200 transition-colors">
                                        Type Manually
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <>
                                <div
                                    className="absolute inset-0 pointer-events-none border-2 border-brand-500/30 m-8 rounded-lg z-10"></div>
                                <div
                                    className="absolute top-1/2 left-8 right-8 h-0.5 bg-red-500 shadow-[0_0_8px_red] z-10 opacity-80 animate-pulse"></div>
                                <div
                                    className="absolute bottom-4 left-0 right-0 text-center text-white/90 text-xs pointer-events-none font-bold z-10 drop-shadow-md">
                                    Align barcode with the red line
                                </div>
                            </>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    // --- SUB COMPONENTS (EXTRACTED) ---
    const ProductDetailPanel = ({product, onClose}) => {
        const [history, setHistory] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            setLoading(true);
            // Fix: Handle paginated response ({ results: [...] }) vs array
            api.get(`logs/?variant_id=${product.id}`).then(data => {
                if (data.results && Array.isArray(data.results)) {
                    setHistory(data.results);
                } else if (Array.isArray(data)) {
                    setHistory(data);
                } else {
                    setHistory([]);
                }
            })
            .catch(e => console.error(e))
            .finally(() => setLoading(false));
        }, [product]);

        return (
            <div className="h-full flex flex-col bg-white shadow-xl animate-fade-in md:rounded-l-xl border-l border-slate-200">
                <div className="flex justify-between items-start p-6 border-b border-slate-100">
                    <div>
                        <h2 className="text-xl font-bold text-slate-800">{product.product_name}</h2>
                        <div className="flex items-center gap-2 mt-1 text-sm text-slate-500 font-mono">
                            <span>{product.sku}</span>
                            <span className="text-slate-300">•</span>
                            <span>{product.barcode}</span>
                        </div>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400">
                        <i className="ph ph-x text-xl"></i>
                    </button>
                </div>

                <div className="p-6 grid grid-cols-3 gap-3 border-b border-slate-100 bg-slate-50/50">
                    <div className="bg-white p-3 rounded-xl border border-slate-200 text-center shadow-sm">
                        <div className="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Stock</div>
                        <div className={`text-2xl font-bold ${product.stock_quantity < 10 ? 'text-red-500' : 'text-slate-700'}`}>{product.stock_quantity}</div>
                    </div>
                    <div className="bg-white p-3 rounded-xl border border-slate-200 text-center shadow-sm">
                        <div className="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Price</div>
                        <div className="text-xl font-bold text-slate-700">{formatCurrency(product.price)}</div>
                    </div>
                    <div className="bg-white p-3 rounded-xl border border-slate-200 text-center shadow-sm">
                        <div className="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Avg Cost</div>
                        <div className="text-xl font-bold text-slate-700">{formatCurrency(product.cost_price || 0)}</div>
                    </div>
                </div>

                <div className="flex-grow overflow-hidden flex flex-col p-6">
                    <h3 className="font-bold text-sm text-slate-700 mb-4 uppercase tracking-wider flex items-center gap-2">
                        <i className="ph ph-clock-counter-clockwise"></i> Movement History
                    </h3>
                    <div className="flex-grow overflow-auto scroller border rounded-xl bg-slate-50">
                        {loading ? (
                            <div className="p-10 text-center text-slate-400 flex flex-col items-center gap-2">
                                <i className="ph ph-spinner animate-spin text-xl"></i> Loading...
                            </div>
                        ) : history.length === 0 ? (
                            <div className="p-10 text-center text-slate-400 italic">No movement history found.</div>
                        ) : (
                            <table className="w-full text-left text-xs">
                                <thead className="bg-slate-100 font-bold border-b text-slate-500 sticky top-0">
                                    <tr>
                                        <th className="p-3">Date</th>
                                        <th className="p-3">Action</th>
                                        <th className="p-3 text-right">Qty</th>
                                        <th className="p-3 text-right">Bal</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-200 bg-white">
                                    {history.map(log => (
                                        <tr key={log.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-3 text-slate-500">
                                                <div className="font-medium text-slate-700">{new Date(log.created_at).toLocaleDateString()}</div>
                                                <div className="text-[10px] opacity-70">{new Date(log.created_at).toLocaleTimeString()}</div>
                                            </td>
                                            <td className="p-3">
                                                <span className={`uppercase font-bold text-[10px] px-1.5 py-0.5 rounded ${
                                                    log.action === 'sale' ? 'bg-emerald-100 text-emerald-700' :
                                                    log.action === 'restock' ? 'bg-blue-100 text-blue-700' :
                                                    'bg-slate-100 text-slate-600'
                                                }`}>
                                                    {log.action}
                                                </span>
                                            </td>
                                            <td className={`p-3 text-right font-bold ${log.quantity_change > 0 ? 'text-emerald-600' : log.quantity_change < 0 ? 'text-red-500' : 'text-slate-400'}`}>
                                                {log.quantity_change > 0 ? '+' : ''}{log.quantity_change}
                                            </td>
                                            <td className="p-3 text-right text-slate-400 font-mono font-medium">{log.stock_after}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    const AddProductModal = ({onClose, onSuccess}) => {
        const [form, setForm] = useState({
            name: '',
            category: '',
            price: '',
            cost: '',
            stock: '',
            barcode: '',
            sku: '',
            tax_rate: '0'
        });
        const [loading, setLoading] = useState(false);
        const [showCamera, setShowCamera] = useState(false);
        const handleSubmit = async (e) => {
            e.preventDefault();
            setLoading(true);
            try {
                await api.post('products/', form);
                onSuccess();
                notify("Product Created!");
            } catch (err) {
                notify(err.message, 'error');
            } finally {
                setLoading(false);
            }
        };
        return (
            <div
                className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in">
                {showCamera && <CameraModal onScan={(code) => {
                    setForm({...form, barcode: code});
                    setShowCamera(false);
                    notify("Scanned!");
                }} onClose={() => setShowCamera(false)}/>}
                <div className="bg-white p-8 rounded-2xl w-96 shadow-2xl">
                    <h2 className="text-2xl font-bold mb-6 text-slate-800">New Product</h2>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <Input label="Name" required onChange={e => setForm({...form, name: e.target.value})}
                               placeholder="e.g. Nike Shirt"/>
                        <div className="grid grid-cols-2 gap-3"><Input label="Category" required
                                                                       onChange={e => setForm({
                                                                           ...form,
                                                                           category: e.target.value
                                                                       })}/><Input label="SKU" required
                                                                                   onChange={e => setForm({
                                                                                       ...form,
                                                                                       sku: e.target.value
                                                                                   })}/></div>
                        <div className="grid grid-cols-2 gap-3"><Input label="Sell Price" type="number" required
                                                                       onChange={e => setForm({
                                                                           ...form,
                                                                           price: e.target.value
                                                                       })}/><Input label="Cost Price" type="number"
                                                                                   required onChange={e => setForm({
                            ...form,
                            cost: e.target.value
                        })}/></div>
                        <div className="grid grid-cols-2 gap-3"><Input label="Stock" type="number" required
                                                                       onChange={e => setForm({
                                                                           ...form,
                                                                           stock: e.target.value
                                                                       })}/>
                            <div className="flex items-end gap-2"><Input label="Barcode" required value={form.barcode}
                                                                         onChange={e => setForm({
                                                                             ...form,
                                                                             barcode: e.target.value
                                                                         })} className="flex-grow"/><Button
                                variant="dark" onClick={() => setShowCamera(true)} className="px-3"><i
                                className="ph ph-camera text-xl"></i></Button></div>
                        </div>
                        <Input label="Tax Rate (%)" type="number" step="0.01"
                               onChange={e => setForm({...form, tax_rate: e.target.value})} placeholder="0.00"/>
                        <div className="flex gap-3 mt-6 pt-2"><Button type="button" variant="ghost" className="w-full"
                                                                      onClick={onClose}>Cancel</Button><Button
                            type="submit" disabled={loading} className="w-full">Create</Button></div>
                    </form>
                </div>
            </div>
        );
    };

    const AddStaffModal = ({onClose, onSuccess}) => {
        const [form, setForm] = useState({username: '', password: '', role: 'Cashier'});
        const submit = async (e) => {
            e.preventDefault();
            try {
                await api.post('staff/', form);
                onSuccess();
                notify("Staff Created!");
            } catch (e) {
                notify(e.message, 'error');
            }
        };
        return (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 animate-fade-in">
                <div className="bg-white p-8 rounded-2xl w-96 shadow-2xl"><h2
                    className="text-2xl font-bold mb-6 text-slate-800">New Staff</h2>
                    <form onSubmit={submit} className="space-y-4"><Input label="Username" required
                                                                         onChange={e => setForm({
                                                                             ...form,
                                                                             username: e.target.value
                                                                         })}/><Input label="Password" type="password"
                                                                                     required onChange={e => setForm({
                        ...form,
                        password: e.target.value
                    })}/>
                        <div className="flex flex-col gap-1"><label
                            className="text-xs font-bold text-slate-500 uppercase tracking-wide">Role</label><select
                            className="w-full p-2.5 rounded-lg border border-slate-300 focus:border-brand-500 outline-none bg-white"
                            onChange={e => setForm({...form, role: e.target.value})}>
                            <option value="Cashier">Cashier</option>
                            <option value="Manager">Manager</option>
                        </select></div>
                        <div className="flex gap-3 mt-6 pt-2"><Button type="button" variant="ghost" className="w-full"
                                                                      onClick={onClose}>Cancel</Button><Button
                            type="submit" className="w-full">Create</Button></div>
                    </form>
                </div>
            </div>
        );
    };

    const AddSupplierModal = ({onClose, onSuccess}) => {
        const [form, setForm] = useState({name: '', contact_person: '', email: ''});
        const submit = async (e) => {
            e.preventDefault();
            try {
                await api.post('suppliers/', form);
                onSuccess();
                notify("Supplier Added");
            } catch (e) {
                notify(e.message, 'error');
            }
        };
        return (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                <div className="bg-white p-6 rounded-xl w-96 animate-fade-in"><h2 className="text-xl font-bold mb-4">New
                    Supplier</h2>
                    <form onSubmit={submit} className="space-y-3"><Input label="Company Name" required
                                                                         onChange={e => setForm({
                                                                             ...form,
                                                                             name: e.target.value
                                                                         })}/><Input label="Contact Person"
                                                                                     onChange={e => setForm({
                                                                                         ...form,
                                                                                         contact_person: e.target.value
                                                                                     })}/><Input label="Email"
                                                                                                 type="email"
                                                                                                 onChange={e => setForm({
                                                                                                     ...form,
                                                                                                     email: e.target.value
                                                                                                 })}/>
                        <div className="flex gap-2 mt-4"><Button type="button" variant="ghost" className="w-full"
                                                                 onClick={onClose}>Cancel</Button><Button type="submit"
                                                                                                          className="w-full">Save</Button>
                        </div>
                    </form>
                </div>
            </div>
        )
    };

    const AddCustomerModal = ({onClose, onSuccess}) => {
        const [form, setForm] = useState({name: '', phone: '', email: '', address: ''});
        const submit = async (e) => {
            e.preventDefault();
            try {
                await api.post('customers/', form);
                onSuccess();
                notify("Customer Added!");
            } catch (e) {
                notify(e.message, 'error');
            }
        };
        return (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 animate-fade-in">
                <div className="bg-white p-8 rounded-2xl w-96 shadow-2xl"><h2
                    className="text-xl font-bold mb-4 text-slate-800">Add Customer</h2>
                    <form onSubmit={submit} className="space-y-3"><Input label="Name" required onChange={e => setForm({
                        ...form,
                        name: e.target.value
                    })}/><Input label="Phone" required onChange={e => setForm({...form, phone: e.target.value})}/><Input
                        label="Email" type="email" onChange={e => setForm({...form, email: e.target.value})}/><Input
                        label="Address" onChange={e => setForm({...form, address: e.target.value})}/>
                        <div className="flex gap-2 mt-4"><Button type="button" variant="ghost" className="w-full"
                                                                 onClick={onClose}>Cancel</Button><Button type="submit"
                                                                                                          className="w-full">Save</Button>
                        </div>
                    </form>
                </div>
            </div>
        );
    };

    // --- COMPONENT: NOTIFICATION HUB ---
    const NotificationHub = () => {
        const [notifs, setNotifs] = useState([]);
        const [show, setShow] = useState(false);

        // Poll for notifications every 30 seconds
        useEffect(() => {
            const fetchNotifs = () => api.get('notifications/').then(setNotifs).catch(e => console.error(e));
            fetchNotifs();
            const interval = setInterval(fetchNotifs, 30000);
            return () => clearInterval(interval);
        }, []);

        const markRead = (id) => {
            api.put(`notifications/${id}/read/`, {}).then(() => setNotifs(n => n.filter(x => x.id !== id)));
        };

        return (
            <div className="relative z-50">
                <button onClick={() => setShow(!show)}
                        className="relative p-2 text-slate-400 hover:text-white transition-colors">
                    <i className="ph ph-bell text-xl"></i>
                    {notifs.length > 0 && <span
                        className="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-slate-900 animate-pulse"></span>}
                </button>
                {show && (
                    <>
                        <div className="fixed inset-0 z-40" onClick={() => setShow(false)}></div>
                        <div
                            className="absolute left-10 bottom-0 w-72 bg-white rounded-xl shadow-2xl border border-slate-200 z-50 overflow-hidden text-slate-800 animate-fade-in">
                            <div
                                className="p-3 border-b bg-slate-50 font-bold text-xs text-slate-500 uppercase flex justify-between items-center">
                                <span>Notifications</span>
                                <span
                                    className="bg-slate-200 px-2 py-0.5 rounded-full text-[10px]">{notifs.length}</span>
                            </div>
                            <div className="max-h-80 overflow-y-auto scroller">
                                {notifs.length === 0 ? (
                                    <div className="p-6 text-center text-slate-400 text-sm italic">No new alerts</div>
                                ) : (
                                    notifs.map(n => (
                                        <div key={n.id}
                                             className="p-3 border-b hover:bg-brand-50 cursor-pointer transition-colors group"
                                             onClick={() => markRead(n.id)}>
                                            <div
                                                className="font-bold text-sm text-slate-700 group-hover:text-brand-700">{n.title}</div>
                                            <div
                                                className="text-xs text-slate-500 mt-1 leading-relaxed">{n.message}</div>
                                            <div
                                                className="text-[10px] text-slate-300 mt-2 text-right">{new Date(n.created_at).toLocaleTimeString()}</div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </>
                )}
            </div>
        );
    };

    // --- UPDATED: DASHBOARD (Responsive) ---
    const Dashboard = ({onNavigate}) => {
        const [stats, setStats] = useState(null);
        const [topSelling, setTopSelling] = useState([]);
        const chartRef = useRef(null);
        const chartInstance = useRef(null);

        useEffect(() => {
            // Fetch Dashboard Stats
            api.get('reports/dashboard/').then(setStats);

            // Fetch Top Selling Items (Utilizing your existing API)
            api.get('reports/top-selling/').then(setTopSelling);

            return () => {
                if (chartInstance.current) chartInstance.current.destroy();
            }
        }, []);

        // Initialize Chart only after stats are loaded
        useEffect(() => {
            if (stats && chartRef.current && typeof Chart !== 'undefined') {
                if (chartInstance.current) chartInstance.current.destroy();

                const ctx = chartRef.current.getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(37, 99, 235, 0.1)'); // Brand Blue
                gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');

                chartInstance.current = new Chart(chartRef.current, {
                    type: 'line',
                    data: {
                        // Simulating a week view for UI demo (Backend would ideally provide history)
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Today'],
                        datasets: [{
                            label: 'Revenue Trend',
                            data: [15000, 18000, 12000, 22000, 19000, 25000, stats.revenue || 0],
                            borderColor: '#2563eb',
                            borderWidth: 2,
                            backgroundColor: gradient,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#ffffff',
                            pointBorderColor: '#2563eb',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {display: false},
                            tooltip: {
                                backgroundColor: '#1e293b',
                                padding: 12,
                                titleFont: {size: 13},
                                bodyFont: {size: 13},
                                displayColors: false,
                                callbacks: {
                                    label: (context) => formatCurrency(context.raw)
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {borderDash: [4, 4], color: '#f1f5f9'},
                                ticks: {font: {size: 10}, color: '#64748b', callback: (val) => '₦' + val}
                            },
                            x: {
                                grid: {display: false},
                                ticks: {font: {size: 10}, color: '#64748b'}
                            }
                        }
                    }
                });
            }
        }, [stats]);

        if (!stats) return <div className="h-full flex items-center justify-center text-slate-400 gap-2"><i
            className="ph ph-spinner animate-spin text-xl"></i> Loading Overview...</div>;

        return (
            <div className="space-y-6 animate-fade-in h-full flex flex-col pb-4 overflow-y-auto scroller">

                {/* Header */}
                <div className="flex justify-between items-end">
                    <div>
                        <h1 className="text-2xl font-bold text-slate-800 tracking-tight">Overview</h1>
                        <p className="text-sm text-slate-500">{new Date().toLocaleDateString('en-US', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        })}</p>
                    </div>
                    <div className="hidden md:block">
                        <Button size="sm" onClick={() => onNavigate('pos')}><i className="ph ph-shopping-cart"></i> Go
                            to POS</Button>
                    </div>
                </div>

                {/* KPI Grid */}
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <Card className="border border-slate-200 shadow-sm hover:shadow-md transition-shadow p-5">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Today's
                                    Revenue</p>
                                <h3 className="text-2xl font-bold text-slate-800 mt-1">{formatCurrency(stats.revenue || 0)}</h3>
                            </div>
                            <div className="p-2 bg-blue-50 text-blue-600 rounded-lg"><i
                                className="ph ph-currency-dollar text-xl"></i></div>
                        </div>
                    </Card>
                    <Card className="border border-slate-200 shadow-sm hover:shadow-md transition-shadow p-5">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Net Profit</p>
                                <h3 className={`text-2xl font-bold mt-1 ${stats.profit >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                    {formatCurrency(stats.profit || 0)}
                                </h3>
                            </div>
                            <div
                                className={`p-2 rounded-lg ${stats.profit >= 0 ? 'bg-emerald-50 text-emerald-600' : 'bg-red-50 text-red-600'}`}>
                                <i className="ph ph-trend-up text-xl"></i>
                            </div>
                        </div>
                    </Card>
                    <Card className="border border-slate-200 shadow-sm hover:shadow-md transition-shadow p-5">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Low Stock
                                    Alerts</p>
                                <h3 className="text-2xl font-bold text-slate-800 mt-1">{stats.low_stock_items || 0}</h3>
                            </div>
                            <div className="p-2 bg-orange-50 text-orange-600 rounded-lg"><i
                                className="ph ph-warning text-xl"></i></div>
                        </div>
                    </Card>
                    <Card
                        className="border-slate-200 shadow-sm hover:shadow-md transition-shadow p-5 bg-slate-800 text-white">
                        <div className="flex justify-between items-start">
                            <div>
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Inventory
                                    Value</p>
                                <h3 className="text-xl font-mono mt-1 text-white opacity-90">View Report &rarr;</h3>
                            </div>
                            <div className="p-2 bg-white/10 text-white rounded-lg cursor-pointer"
                                 onClick={() => api.download('export/inventory/')}>
                                <i className="ph ph-download-simple text-xl"></i>
                            </div>
                        </div>
                    </Card>
                </div>

                {/* Main Content Area */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow">

                    {/* Left: Performance Chart */}
                    <Card className="lg:col-span-2 flex flex-col min-h-[350px] shadow-sm border border-slate-200">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-slate-700">Revenue Performance</h3>
                            <select
                                className="text-xs bg-slate-50 border border-slate-200 rounded px-2 py-1 outline-none text-slate-600">
                                <option>Last 7 Days</option>
                            </select>
                        </div>
                        <div className="flex-grow relative w-full">
                            <canvas ref={chartRef}></canvas>
                        </div>
                    </Card>

                    {/* Right: Top Selling Items */}
                    <Card className="flex flex-col shadow-sm border border-slate-200 h-full max-h-[400px]">
                        <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <i className="ph ph-trophy text-amber-500"></i> Top Selling Today
                        </h3>
                        <div className="overflow-y-auto scroller flex-grow -mx-2 px-2">
                            {topSelling.length === 0 ? (
                                <div className="text-center text-slate-400 text-sm py-10">No sales yet today.</div>
                            ) : (
                                <table className="w-full text-sm text-left">
                                    <tbody className="divide-y divide-slate-100">
                                    {topSelling.map((item, idx) => (
                                        <tr key={idx}>
                                            <td className="py-3">
                                                <div
                                                    className="font-medium text-slate-700 truncate max-w-[120px]">{item.variant__product__name}</div>
                                                <div
                                                    className="text-xs text-slate-400">{item.variant__name_suffix}</div>
                                            </td>
                                            <td className="py-3 text-right">
                                                <div className="font-bold text-slate-700">{item.total_sold} <span
                                                    className="text-[10px] font-normal text-slate-400">sold</span></div>
                                            </td>
                                        </tr>
                                    ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                        <button onClick={() => onNavigate('sales')}
                                className="w-full mt-4 py-2 text-xs font-bold text-brand-600 bg-brand-50 hover:bg-brand-100 rounded-lg transition-colors">
                            View Full Sales Ledger
                        </button>
                    </Card>
                </div>

                {/* Bottom: Quick Actions Strip */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onClick={() => onNavigate('inventory', true)}
                            className="flex items-center justify-center gap-2 p-3 bg-white border border-slate-200 rounded-xl hover:border-brand-500 hover:text-brand-600 hover:shadow-md transition-all text-slate-600 font-medium text-sm">
                        <i className="ph ph-plus-circle text-lg"></i> Add Product
                    </button>
                    <button onClick={() => onNavigate('procurement', true)}
                            className="flex items-center justify-center gap-2 p-3 bg-white border border-slate-200 rounded-xl hover:border-emerald-500 hover:text-emerald-600 hover:shadow-md transition-all text-slate-600 font-medium text-sm">
                        <i className="ph ph-truck text-lg"></i> Create PO
                    </button>
                    <button onClick={() => api.download('print-labels/')}
                            className="flex items-center justify-center gap-2 p-3 bg-white border border-slate-200 rounded-xl hover:border-orange-500 hover:text-orange-600 hover:shadow-md transition-all text-slate-600 font-medium text-sm">
                        <i className="ph ph-barcode text-lg"></i> Print Labels
                    </button>
                    <button onClick={() => api.download('backup/')}
                            className="flex items-center justify-center gap-2 p-3 bg-white border border-slate-200 rounded-xl hover:border-purple-500 hover:text-purple-600 hover:shadow-md transition-all text-slate-600 font-medium text-sm">
                        <i className="ph ph-database text-lg"></i> Backup Data
                    </button>
                </div>
            </div>
        );
    };

    // --- UPDATED: INVENTORY MANAGER (Responsive) ---
     const InventoryManager = ({openModalOnLoad}) => {
        const [products, setProducts] = useState([]);
        const [selected, setSelected] = useState([]);
        const [search, setSearch] = useState("");
        const [categoryFilter, setCategoryFilter] = useState("all");
        const [showModal, setShowModal] = useState(openModalOnLoad || false);
        const [page, setPage] = useState(1);
        const [activeProduct, setActiveProduct] = useState(null);
        const PER_PAGE = 15;

        useEffect(() => { loadProducts(); }, [search]);

        const loadProducts = () => {
            const query = search ? `?search=${search}` : '';
            api.get(`products/${query}`).then(res => {
                setProducts(res);
                setPage(1);
                setSelected([]);
            });
        }

        const categories = useMemo(() => {
            const cats = new Set(products.map(p => p.category).filter(Boolean));
            return ["all", ...Array.from(cats)];
        }, [products]);

        const filteredProducts = useMemo(() => {
            let res = products;
            if (categoryFilter !== "all") {
                res = res.filter(p => p.category === categoryFilter);
            }
            return res;
        }, [products, categoryFilter]);

        const paginatedProducts = useMemo(() => {
            const start = (page - 1) * PER_PAGE;
            return filteredProducts.slice(start, start + PER_PAGE);
        }, [filteredProducts, page]);

        const stats = useMemo(() => {
            const totalItems = products.length;
            const lowStock = products.filter(p => p.stock_quantity < 10).length;
            const totalValue = products.reduce((acc, p) => acc + (parseFloat(p.price) * p.stock_quantity), 0);
            return { totalItems, lowStock, totalValue };
        }, [products]);

        const toggleSelect = (id) => setSelected(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
        const toggleAll = () => setSelected(prev => prev.length === filteredProducts.length ? [] : filteredProducts.map(p => p.id));

        const handlePrint = () => {
            const query = selected.length > 0 ? `?ids=${selected.join(',')}` : '';
            api.download(`print-labels/${query}`);
            notify(selected.length > 0 ? `Downloading ${selected.length} Labels...` : "Downloading All Labels...");
        };

        const handleDelete = async (id, e) => {
            e.stopPropagation();
            if(!confirm("Are you sure you want to archive this product?")) return;
            const previousProducts = [...products];
            setProducts(current => current.filter(p => p.id !== id));
            try {
                await api.delete(`products/${id}/`);
                notify("Product Archived");
                loadProducts();
            } catch (e) {
                setProducts(previousProducts);
                notify(e.message, 'error');
            }
        };

        return (
            <div className="h-full flex flex-col md:flex-row gap-6 animate-fade-in relative">
                {showModal && <AddProductModal onClose={() => setShowModal(false)} onSuccess={() => {
                    setShowModal(false);
                    loadProducts();
                }}/>}

                <div className={`flex-col gap-4 h-full flex transition-all duration-300 ${activeProduct ? 'hidden md:flex md:w-1/2 lg:w-7/12' : 'w-full'}`}>

                    <div className="flex flex-col gap-4">
                        <div className="flex flex-col md:flex-row justify-between md:items-center gap-4">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800">Inventory</h1>
                                <div className="flex gap-4 text-xs text-slate-500 mt-1">
                                    <span><b className="text-slate-800">{stats.totalItems}</b> Items</span>
                                    <span><b className="text-orange-600">{stats.lowStock}</b> Low Stock</span>
                                    <span>Value: <b className="text-emerald-600">{formatCurrency(stats.totalValue)}</b></span>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <Button variant="dark" onClick={handlePrint} disabled={filteredProducts.length === 0} className="shadow-none border border-slate-700">
                                    <i className="ph ph-printer"></i> <span className="hidden sm:inline">Labels</span>
                                </Button>
                                <Button onClick={() => setShowModal(true)} className="shadow-brand-200">
                                    <i className="ph ph-plus"></i> <span className="hidden sm:inline">Add Product</span>
                                </Button>
                            </div>
                        </div>

                        <div className="flex flex-col sm:flex-row gap-2">
                            <div className="relative flex-grow">
                                <i className="ph ph-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                                <input
                                    placeholder="Search by Name, SKU, Barcode..."
                                    className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:border-brand-500 transition-all bg-white shadow-sm"
                                    value={search} onChange={e => setSearch(e.target.value)}
                                />
                            </div>
                            <select
                                className="p-2.5 rounded-xl border border-slate-200 bg-white outline-none focus:border-brand-500 shadow-sm text-sm font-medium text-slate-600 min-w-[150px]"
                                value={categoryFilter}
                                onChange={(e) => setCategoryFilter(e.target.value)}
                            >
                                <option value="all">All Categories</option>
                                {categories.filter(c => c !== 'all').map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                        </div>
                    </div>

                    <Card className="flex-grow p-0 overflow-hidden flex flex-col border-0 shadow-md">
                        <div className="overflow-auto scroller h-full">
                            <table className="w-full text-left text-sm min-w-[700px]">
                                <thead className="bg-slate-50 font-bold border-b text-slate-500 sticky top-0 z-10 text-xs uppercase tracking-wide">
                                <tr>
                                    <th className="p-4 w-10 text-center"><input type="checkbox" className="w-4 h-4 rounded cursor-pointer accent-brand-600" onChange={toggleAll} checked={filteredProducts.length > 0 && selected.length === filteredProducts.length}/></th>
                                    <th className="p-4">Product Details</th>
                                    <th className="p-4">Barcode</th> {/* Added Barcode Column */}
                                    <th className="p-4">Category</th>
                                    <th className="p-4 text-right">Price</th>
                                    <th className="p-4 text-right">Stock</th>
                                    <th className="p-4 w-12"></th>
                                </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100 bg-white">
                                    {paginatedProducts.map(p => (
                                    <tr key={p.id} onClick={() => setActiveProduct(p)}
                                        className={`group cursor-pointer transition-colors ${activeProduct?.id === p.id ? 'bg-brand-50' : 'hover:bg-slate-50'} ${p.stock_quantity < 10 ? 'bg-orange-50/30' : ''}`}>
                                        <td className="p-4 text-center" onClick={e => e.stopPropagation()}>
                                            <input type="checkbox" className="w-4 h-4 rounded cursor-pointer accent-brand-600" checked={selected.includes(p.id)} onChange={() => toggleSelect(p.id)}/>
                                        </td>
                                        <td className="p-4">
                                            <div className="font-bold text-slate-700 group-hover:text-brand-700 transition-colors">{p.product_name}</div>
                                            <div className="text-xs text-slate-400 font-mono mt-0.5">
                                                {p.sku} • {p.name_suffix}
                                            </div>
                                        </td>
                                        <td className="p-4 font-mono text-xs text-slate-600 select-all">{p.barcode}</td> {/* Display Barcode */}
                                        <td className="p-4">
                                            <span className="px-2.5 py-1 rounded-full bg-slate-100 text-slate-600 text-xs font-bold border border-slate-200">
                                                {p.category}
                                            </span>
                                        </td>
                                        <td className="p-4 text-right font-mono font-bold text-slate-700">{formatCurrency(p.price)}</td>
                                        <td className="p-4 text-right">
                                            <span className={`font-bold px-2 py-1 rounded text-xs ${p.stock_quantity < 10 ? 'bg-red-100 text-red-600' : 'bg-emerald-50 text-emerald-600'}`}>
                                                {p.stock_quantity}
                                            </span>
                                        </td>
                                        <td className="p-4 text-right">
                                            <button onClick={(e) => handleDelete(p.id, e)}
                                                className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all opacity-0 group-hover:opacity-100"
                                                title="Archive">
                                                <i className="ph ph-trash text-lg"></i>
                                            </button>
                                        </td>
                                    </tr>))}
                                    {paginatedProducts.length === 0 && (
                                        <tr><td colSpan="7" className="p-12 text-center text-slate-400 italic">No products found.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                        <div className="border-t p-2 bg-slate-50"><Pagination total={filteredProducts.length} page={page} setPage={setPage} perPage={PER_PAGE}/></div>
                    </Card>
                </div>

                {/* DETAIL PANEL (Sliding Overlay) */}
                {activeProduct && (
                    <div className="fixed inset-0 z-50 md:static md:z-0 md:w-1/2 lg:w-5/12 h-full bg-slate-900/20 backdrop-blur-sm md:backdrop-blur-none md:bg-transparent flex justify-end animate-fade-in">
                        <div className="w-full md:w-auto md:flex-grow h-full max-w-lg bg-white shadow-2xl md:shadow-none md:border-l border-slate-200 overflow-hidden">
                            <ProductDetailPanel product={activeProduct} onClose={() => setActiveProduct(null)}/>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const Procurement = ({openCreateOnLoad}) => {
        const [activeTab, setActiveTab] = useState(openCreateOnLoad ? 'create_po' : 'orders');
        const [pos, setPos] = useState([]);
        const [suppliers, setSuppliers] = useState([]);
        const [loading, setLoading] = useState(false);
        const [showSupplierModal, setShowSupplierModal] = useState(false);

        useEffect(() => {
            loadData();
        }, []);

        const loadData = () => {
            setLoading(true);
            Promise.all([
                api.get('po/list/'),
                api.get('suppliers/')
            ]).then(([poData, supData]) => {
                setPos(poData);
                setSuppliers(supData);
            }).finally(() => setLoading(false));
        };

        // --- ACTIONS ---
        const deleteSupplier = async (id) => {
            if (!confirm("Delete supplier? Only allowed if no Purchase Orders exist.")) return;
            try {
                await api.delete(`suppliers/${id}/`);
                notify("Supplier Deleted");
                setSuppliers(prev => prev.filter(s => s.id !== id));
            } catch (e) {
                notify(e.message, 'error');
            }
        };

        const receivePO = async (id) => {
            if (!confirm("Confirm receipt of goods? Inventory levels will be updated.")) return;
            try {
                await api.post(`po/${id}/receive/`, {});
                notify("Stock Received & Updated!");
                loadData(); // Refresh to show status change
            } catch (e) {
                notify(e.message, 'error');
            }
        };

        // --- SUB-COMPONENT: CREATE PO FORM ---
        const CreatePO = ({onCancel, onSuccess}) => {
            const [form, setForm] = useState({supplier_id: '', items: []});
            const [line, setLine] = useState({variant_id: '', qty: '', cost: ''});
            const [products, setProducts] = useState([]);

            useEffect(() => {
                api.get('products/').then(setProducts);
            }, []);

            const addLine = () => {
                if (!line.variant_id || !line.qty || !line.cost) return notify("Please fill all item fields", 'error');
                const product = products.find(p => p.id == line.variant_id);
                setForm(p => ({
                    ...p,
                    items: [...p.items, {
                        variant_id: line.variant_id,
                        name: product?.product_name,
                        sku: product?.sku,
                        quantity: parseInt(line.qty),
                        cost: parseFloat(line.cost)
                    }]
                }));
                setLine({variant_id: '', qty: '', cost: ''});
            };

            const removeLine = (idx) => setForm(p => ({...p, items: p.items.filter((_, i) => i !== idx)}));

            const submit = async () => {
                if (!form.supplier_id) return notify("Select a Supplier", 'error');
                if (form.items.length === 0) return notify("Add at least one item", 'error');
                try {
                    await api.post('po/create/', form);
                    notify("Purchase Order Created");
                    onSuccess();
                } catch (e) {
                    notify(e.message, 'error');
                }
            };

            const grandTotal = form.items.reduce((acc, i) => acc + (i.quantity * i.cost), 0);

            return (
                <div className="flex flex-col h-full gap-6 animate-fade-in">
                    <div className="flex items-center gap-4">
                        <button onClick={onCancel} className="p-2 rounded-full hover:bg-slate-200 transition-colors"><i
                            className="ph ph-arrow-left text-xl"></i></button>
                        <h1 className="text-2xl font-bold text-slate-800">New Purchase Order</h1>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow overflow-hidden">
                        {/* LEFT: FORM INPUTS */}
                        <div className="lg:col-span-2 flex flex-col gap-6 overflow-y-auto scroller pr-2">
                            <Card>
                                <label
                                    className="text-xs font-bold uppercase text-slate-500 mb-2 block">Supplier</label>
                                <select
                                    className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-brand-500"
                                    onChange={e => setForm({...form, supplier_id: e.target.value})}>
                                    <option value="">Select Supplier...</option>
                                    {suppliers.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </Card>

                            <Card className="flex-grow flex flex-col gap-4">
                                <div className="flex justify-between items-center border-b pb-2">
                                    <h3 className="font-bold text-slate-700">Add Items</h3>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                                    <div className="md:col-span-6">
                                        <label className="text-xs font-bold text-slate-400">Product</label>
                                        <select className="w-full p-2 border rounded mt-1 text-sm"
                                                value={line.variant_id}
                                                onChange={e => setLine({...line, variant_id: e.target.value})}>
                                            <option value="">Choose...</option>
                                            {products.map(p => <option key={p.id}
                                                                       value={p.id}>{p.product_name} ({p.sku})</option>)}
                                        </select>
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="text-xs font-bold text-slate-400">Qty</label>
                                        <input type="number" className="w-full p-2 border rounded mt-1 text-sm"
                                               value={line.qty}
                                               onChange={e => setLine({...line, qty: e.target.value})}/>
                                    </div>
                                    <div className="md:col-span-3">
                                        <label className="text-xs font-bold text-slate-400">Unit Cost</label>
                                        <input type="number" className="w-full p-2 border rounded mt-1 text-sm"
                                               value={line.cost}
                                               onChange={e => setLine({...line, cost: e.target.value})}/>
                                    </div>
                                    <div className="md:col-span-1">
                                        <Button onClick={addLine} size="sm" variant="dark"
                                                className="w-full h-[38px]"><i className="ph ph-plus"></i></Button>
                                    </div>
                                </div>

                                <div className="mt-4 border rounded-lg overflow-hidden">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-50 text-slate-500 font-bold">
                                        <tr>
                                            <th className="p-3">Product</th>
                                            <th className="p-3 text-center">Qty</th>
                                            <th className="p-3 text-right">Cost</th>
                                            <th className="p-3"></th>
                                        </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                        {form.items.length === 0 && <tr>
                                            <td colSpan="4" className="p-4 text-center text-slate-400 italic">No items
                                                added.
                                            </td>
                                        </tr>}
                                        {form.items.map((item, idx) => (
                                            <tr key={idx}>
                                                <td className="p-3 font-medium">{item.name} <span
                                                    className="text-xs text-slate-400 block">{item.sku}</span></td>
                                                <td className="p-3 text-center">{item.quantity}</td>
                                                <td className="p-3 text-right">{formatCurrency(item.cost)}</td>
                                                <td className="p-3 text-right">
                                                    <button onClick={() => removeLine(idx)}
                                                            className="text-red-400 hover:text-red-600"><i
                                                        className="ph ph-trash"></i></button>
                                                </td>
                                            </tr>
                                        ))}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </div>

                        {/* RIGHT: SUMMARY */}
                        <div className="lg:col-span-1">
                            <Card className="bg-slate-800 text-white border-0 shadow-xl sticky top-0">
                                <h3 className="font-bold text-slate-400 text-xs uppercase mb-4">Order Summary</h3>
                                <div className="flex justify-between items-center mb-2">
                                    <span>Total Items</span>
                                    <span className="font-bold">{form.items.reduce((a, b) => a + b.quantity, 0)}</span>
                                </div>
                                <div
                                    className="flex justify-between items-center text-xl font-bold pt-4 border-t border-slate-600 mt-2">
                                    <span>Total Cost</span>
                                    <span>{formatCurrency(grandTotal)}</span>
                                </div>
                                <Button onClick={submit}
                                        className="w-full mt-6 py-3 bg-brand-500 hover:bg-brand-400 text-white font-bold">Create
                                    Order</Button>
                            </Card>
                        </div>
                    </div>
                </div>
            );
        };

        if (activeTab === 'create_po') return <CreatePO onCancel={() => setActiveTab('orders')} onSuccess={() => {
            setActiveTab('orders');
            loadData();
        }}/>;

        return (
            <div className="h-full flex flex-col gap-6 animate-fade-in relative">
                {showSupplierModal && <AddSupplierModal onClose={() => setShowSupplierModal(false)} onSuccess={() => {
                    setShowSupplierModal(false);
                    loadData();
                }}/>}

                {/* Header & Tabs */}
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <h1 className="text-2xl font-bold text-slate-800">Procurement</h1>
                    <div className="flex bg-white p-1 rounded-lg border shadow-sm">
                        <button onClick={() => setActiveTab('orders')}
                                className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${activeTab === 'orders' ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:bg-slate-50'}`}>Purchase
                            Orders
                        </button>
                        <button onClick={() => setActiveTab('suppliers')}
                                className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${activeTab === 'suppliers' ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:bg-slate-50'}`}>Suppliers
                        </button>
                    </div>
                </div>

                {/* VIEW: PURCHASE ORDERS */}
                {activeTab === 'orders' && (
                    <div className="flex-grow flex flex-col gap-4 overflow-hidden">
                        <div className="flex justify-end">
                            <Button onClick={() => setActiveTab('create_po')} className="shadow-brand-200"><i
                                className="ph ph-plus"></i> New Purchase Order</Button>
                        </div>
                        <Card className="flex-grow p-0 overflow-hidden flex flex-col border-0 shadow-md">
                            <div className="overflow-auto scroller h-full">
                                <table className="w-full text-left text-sm min-w-[600px]">
                                    <thead className="bg-slate-50 font-bold border-b sticky top-0 text-slate-500 z-10">
                                    <tr>
                                        <th className="p-4">PO Number</th>
                                        <th className="p-4">Supplier</th>
                                        <th className="p-4">Date</th>
                                        <th className="p-4">Status</th>
                                        <th className="p-4 text-right">Cost</th>
                                        <th className="p-4"></th>
                                    </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 bg-white">
                                    {pos.map(p => (
                                        <tr key={p.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-4 font-mono font-bold text-brand-600">#{p.id}</td>
                                            <td className="p-4 font-medium text-slate-700">{p.supplier_name}</td>
                                            <td className="p-4 text-slate-500">{formatDate(p.created_at)}</td>
                                            <td className="p-4">
                                                    <span
                                                        className={`px-2 py-1 rounded text-xs font-bold uppercase ${p.status === 'received' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-600'}`}>
                                                        {p.status}
                                                    </span>
                                            </td>
                                            <td className="p-4 text-right font-mono font-bold text-slate-700">{formatCurrency(p.total_cost)}</td>
                                            <td className="p-4 text-right">
                                                {p.status === 'draft' && (
                                                    <Button size="sm" variant="success" onClick={() => receivePO(p.id)}
                                                            className="text-xs py-1 px-3">
                                                        Receive
                                                    </Button>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                    {pos.length === 0 && <tr>
                                        <td colSpan="6" className="p-10 text-center text-slate-400 italic">No Purchase
                                            Orders found.
                                        </td>
                                    </tr>}
                                    </tbody>
                                </table>
                            </div>
                        </Card>
                    </div>
                )}

                {/* VIEW: SUPPLIERS */}
                {activeTab === 'suppliers' && (
                    <div className="flex-grow flex flex-col gap-4 overflow-hidden">
                        <div className="flex justify-end">
                            <Button onClick={() => setShowSupplierModal(true)} variant="dark"><i
                                className="ph ph-user-plus"></i> Add Supplier</Button>
                        </div>

                        <div
                            className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto scroller pb-4">
                            {suppliers.map(s => (
                                <Card key={s.id}
                                      className="hover:shadow-lg transition-shadow border-t-4 border-t-slate-200">
                                    <div className="flex justify-between items-start mb-4">
                                        <div
                                            className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-lg">
                                            {s.name.charAt(0)}
                                        </div>
                                        <button onClick={() => deleteSupplier(s.id)}
                                                className="text-slate-300 hover:text-red-500 transition-colors">
                                            <i className="ph ph-trash text-xl"></i>
                                        </button>
                                    </div>
                                    <h3 className="font-bold text-lg text-slate-800 mb-1">{s.name}</h3>
                                    <p className="text-sm text-brand-600 mb-4 font-medium">{s.contact_person}</p>

                                    <div className="space-y-2 text-sm text-slate-500">
                                        {s.email && <div className="flex items-center gap-2"><i
                                            className="ph ph-envelope"></i> {s.email}</div>}
                                        {s.phone_number && <div className="flex items-center gap-2"><i
                                            className="ph ph-phone"></i> {s.phone_number}</div>}
                                    </div>
                                </Card>
                            ))}
                            {suppliers.length === 0 && (
                                <div
                                    className="col-span-full p-10 text-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">
                                    No suppliers added yet.
                                </div>
                            )}
                        </div>
                    </div>
                )}
            </div>
        );
    };

      const AuditLogs = () => {
        const [logs, setLogs] = useState([]);
        const [loading, setLoading] = useState(false);
        const [search, setSearch] = useState('');
        const [debouncedSearch, setDebouncedSearch] = useState('');
        const [page, setPage] = useState(1);
        const [hasMore, setHasMore] = useState(true);
        const [dateRange, setDateRange] = useState({
            start: new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0],
            end: new Date().toISOString().split('T')[0]
        });

        // 1. Debounce Search to prevent API spam
        useEffect(() => {
            const timer = setTimeout(() => setDebouncedSearch(search), 500);
            return () => clearTimeout(timer);
        }, [search]);

        // 2. Load Data when Filters Change
        useEffect(() => {
            setPage(1);
            setHasMore(true);
            loadLogs(1, true); // Reset list
        }, [debouncedSearch, dateRange]);

        const loadLogs = (pageNum, reset = false) => {
            setLoading(true);
            // Construct Query
            const query = `?page=${pageNum}&search=${encodeURIComponent(debouncedSearch)}&start_date=${dateRange.start}&end_date=${dateRange.end}`;

            api.get(`logs/${query}`).then(data => {
                let newLogs = [];
                let hasNextPage = false;

                // Handle Django DRF Pagination Response { results: [...], next: "url" }
                if (data && data.results && Array.isArray(data.results)) {
                    newLogs = data.results;
                    hasNextPage = !!data.next;
                } else if (Array.isArray(data)) {
                    // Handle Flat List Response (Fallback)
                    newLogs = data;
                    hasNextPage = false;
                }

                setLogs(prev => reset ? newLogs : [...prev, ...newLogs]);
                setHasMore(hasNextPage);
            })
            .catch(e => {
                console.error("Audit Log Error:", e);
                if(reset) setLogs([]); // Clear list on error if it was a search
                // Don't show toast on 404 (empty list), only on real errors
                if(!e.message.includes("404")) notify("Failed to load history", "error");
            })
            .finally(() => setLoading(false));
        };

        const loadMore = () => {
            const nextPage = page + 1;
            setPage(nextPage);
            loadLogs(nextPage, false);
        };

        // 3. Safe Grouping Logic
        const groupedLogs = useMemo(() => {
            if (!Array.isArray(logs)) return {};

            const grouped = {};
            logs.forEach(log => {
                if (!log?.created_at) return;
                try {
                    const date = new Date(log.created_at).toLocaleDateString(undefined, {
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                    });
                    if (!grouped[date]) grouped[date] = [];
                    grouped[date].push(log);
                } catch (e) {
                    console.warn("Invalid date in log:", log);
                }
            });
            return grouped;
        }, [logs]);

        // 4. Safe Filtering Logic (Client-side refinement)
        const filteredGroups = useMemo(() => {
            if (!debouncedSearch) return groupedLogs; // Server handles main search, this is just extra safety
            return groupedLogs;
        }, [groupedLogs, debouncedSearch]);

        const getActionIcon = (action) => {
            const a = action ? action.toLowerCase() : '';
            if(a.includes('sale')) return { icon: 'ph-currency-dollar', color: 'bg-emerald-100 text-emerald-600', label: 'Sale' };
            if(a.includes('restock')) return { icon: 'ph-truck', color: 'bg-blue-100 text-blue-600', label: 'Restock' };
            if(a.includes('loss')) return { icon: 'ph-warning', color: 'bg-red-100 text-red-600', label: 'Damage/Loss' };
            if(a.includes('audit')) return { icon: 'ph-clipboard-text', color: 'bg-purple-100 text-purple-600', label: 'Audit' };
            return { icon: 'ph-info', color: 'bg-slate-100 text-slate-600', label: 'Update' };
        };

        return (
            <div className="h-full flex flex-col gap-6 animate-fade-in relative">
                {/* Header & Filters */}
                <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm z-10">
                    <div>
                        <h1 className="text-2xl font-bold text-slate-800">Audit Trail</h1>
                        <p className="text-sm text-slate-500">Track inventory movements & user actions</p>
                    </div>

                    <div className="flex flex-col md:flex-row gap-3 w-full xl:w-auto">
                        <div className="flex items-center gap-2 bg-slate-50 p-1 rounded-lg border overflow-x-auto">
                            <input type="date" className="p-2 text-sm bg-transparent outline-none font-medium text-slate-600"
                                value={dateRange.start} onChange={e => setDateRange({...dateRange, start: e.target.value})} />
                            <span className="text-slate-400">-</span>
                            <input type="date" className="p-2 text-sm bg-transparent outline-none font-medium text-slate-600"
                                value={dateRange.end} onChange={e => setDateRange({...dateRange, end: e.target.value})} />
                        </div>

                        <div className="relative flex-grow md:w-64">
                            <i className="ph ph-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                            <input
                                placeholder="Search logs..."
                                className="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-200 outline-none focus:border-brand-500 bg-white shadow-sm transition-all"
                                value={search}
                                onChange={e => setSearch(e.target.value)}
                            />
                        </div>
                    </div>
                </div>

                {/* Timeline List */}
                <div className="flex-grow overflow-y-auto scroller relative -mx-4 md:mx-0 px-4 md:px-0">
                    {loading && logs.length === 0 ? (
                        <div className="flex justify-center items-center h-40 text-slate-400 gap-2">
                            <i className="ph ph-spinner animate-spin text-xl"></i> Loading history...
                        </div>
                    ) : Object.keys(filteredGroups).length === 0 ? (
                        <div className="text-center p-12 text-slate-400 italic bg-white rounded-xl border border-dashed border-slate-200 flex flex-col items-center gap-2 m-4">
                            <i className="ph ph-list-magnifying-glass text-3xl opacity-50"></i>
                            <p>No records found for this period.</p>
                        </div>
                    ) : (
                        <div className="space-y-8 pb-10">
                            {Object.keys(filteredGroups).map(date => (
                                <div key={date} className="relative">
                                    <div className="sticky top-0 z-10 bg-slate-100 py-2 mb-4 pl-4 md:pl-0">
                                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider bg-white px-3 py-1 rounded-full border border-slate-200 shadow-sm inline-flex items-center gap-2">
                                            <i className="ph ph-calendar-blank"></i> {date}
                                        </span>
                                    </div>

                                    <div className="space-y-4 pl-8 md:pl-0 pr-4 md:pr-0">
                                        <div className="absolute left-10 md:left-8 top-10 bottom-0 w-px bg-slate-200 md:hidden"></div>

                                        {filteredGroups[date].map(log => {
                                            const meta = getActionIcon(log.action);
                                            return (
                                                <div key={log.id} className="relative flex flex-col md:flex-row gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow group">

                                                    {/* Mobile Timeline Dot */}
                                                    <div className={`absolute -left-6 top-6 w-3 h-3 rounded-full border-2 border-white shadow-sm md:hidden ${meta.color.replace('text-', 'bg-').replace('bg-', '')}`}></div>

                                                    <div className={`w-12 h-12 rounded-full flex-shrink-0 flex items-center justify-center text-xl ${meta.color}`}>
                                                        <i className={`ph ${meta.icon}`}></i>
                                                    </div>

                                                    <div className="flex-grow min-w-0">
                                                        <div className="flex justify-between items-start">
                                                            <div>
                                                                <h4 className="font-bold text-slate-800 text-sm md:text-base">
                                                                    {log.product_name || 'Unknown Product'}
                                                                    <span className="text-slate-400 font-normal ml-2 text-xs hidden sm:inline">{log.sku}</span>
                                                                </h4>
                                                                <div className="text-xs text-slate-500 mt-1 flex flex-wrap items-center gap-2">
                                                                    <span className="font-bold text-slate-700 bg-slate-100 px-1.5 py-0.5 rounded uppercase text-[10px] tracking-wide">{meta.label}</span>
                                                                    <span>by <b className="text-slate-600">{log.user_name || 'System'}</b></span>
                                                                    <span className="text-slate-300">•</span>
                                                                    <span className="font-mono">{new Date(log.created_at).toLocaleTimeString()}</span>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className={`text-lg font-bold font-mono ${log.quantity_change > 0 ? 'text-emerald-600' : log.quantity_change < 0 ? 'text-red-500' : 'text-slate-400'}`}>
                                                                    {log.quantity_change > 0 ? '+' : ''}{log.quantity_change}
                                                                </div>
                                                                <div className="text-[10px] text-slate-400 uppercase font-bold tracking-wide mt-1">
                                                                    Bal: {log.stock_after}
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {log.note && (
                                                            <div className="mt-3 text-sm text-slate-600 bg-slate-50 p-2 rounded border border-slate-100 italic flex items-start gap-2">
                                                                <i className="ph ph-note text-slate-400 mt-0.5 flex-shrink-0"></i>
                                                                <span className="break-all">{log.note}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}

                            {/* Load More Button */}
                            {hasMore && (
                                <div className="flex justify-center pt-4 pb-8">
                                    <button
                                        onClick={loadMore}
                                        disabled={loading}
                                        className="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-6 py-2 rounded-full font-medium shadow-sm flex items-center gap-2 transition-all disabled:opacity-50"
                                    >
                                        {loading ? <i className="ph ph-spinner animate-spin"></i> : <i className="ph ph-caret-down"></i>}
                                        Load More Activity
                                    </button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        );
    };


    const StaffManager = () => {
        const [staff, setStaff] = useState([]);
        const [showModal, setShowModal] = useState(false);
        const [loading, setLoading] = useState(false);

        useEffect(() => { loadStaff(); }, []);

        const loadStaff = () => {
            setLoading(true);
            api.get('staff/').then(setStaff).finally(() => setLoading(false));
        }

        const toggleStatus = async (id) => {
            if (!confirm("Change access status for this user?")) return;
            try {
                await api.post(`staff/${id}/toggle/`, {});
                notify("Status Updated");
                loadStaff();
            } catch (e) { notify(e.message, 'error'); }
        };

        const handleDelete = async (id) => {
            if(!confirm("Permanently delete this staff member?")) return;
            try {
                await api.delete(`staff/${id}/`);
                notify("Staff Deleted");
                setStaff(prev => prev.filter(u => u.id !== id));
            } catch (e) { notify(e.message, 'error'); }
        };

        return (
            <div className="h-full flex flex-col gap-6 animate-fade-in relative">
                {showModal && <AddStaffModal onClose={() => setShowModal(false)} onSuccess={() => { setShowModal(false); loadStaff(); }}/>}

                {/* Header */}
                <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div>
                        <h1 className="text-2xl font-bold text-slate-800">Team Members</h1>
                        <p className="text-sm text-slate-500">Manage access and roles</p>
                    </div>
                    <Button onClick={() => setShowModal(true)} className="shadow-brand-200">
                        <i className="ph ph-user-plus text-lg"></i> <span className="hidden sm:inline">Add Staff</span>
                    </Button>
                </div>

                {/* Staff Grid */}
                <div className="overflow-y-auto scroller -mx-2 px-2 pb-4">
                    {loading && staff.length === 0 ? (
                        <div className="p-10 text-center text-slate-400"><i className="ph ph-spinner animate-spin"></i> Loading...</div>
                    ) : (
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {staff.map(u => (
                                <div key={u.id} className="bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow p-5 flex flex-col relative overflow-hidden group">
                                    {/* Role Badge */}
                                    <div className={`absolute top-0 right-0 px-3 py-1 rounded-bl-xl text-[10px] font-bold uppercase tracking-wider ${u.role === 'Manager' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                        {u.role}
                                    </div>

                                    {/* Avatar & Info */}
                                    <div className="flex items-center gap-4 mb-4">
                                        <div className={`w-14 h-14 rounded-full flex items-center justify-center text-xl font-bold text-white shadow-sm ${u.is_active ? 'bg-gradient-to-br from-slate-700 to-slate-900' : 'bg-slate-300'}`}>
                                            {u.username.charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-lg text-slate-800">{u.username}</h3>
                                            <div className="flex items-center gap-1.5 text-xs font-medium">
                                                <div className={`w-2 h-2 rounded-full ${u.is_active ? 'bg-emerald-500 animate-pulse' : 'bg-red-400'}`}></div>
                                                <span className={u.is_active ? 'text-emerald-600' : 'text-slate-400'}>
                                                    {u.is_active ? 'Active Now' : 'Access Revoked'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Dates */}
                                    <div className="text-xs text-slate-400 mb-6 flex flex-col gap-1 bg-slate-50 p-2 rounded-lg">
                                        <div className="flex justify-between">
                                            <span>Joined</span>
                                            <span className="font-medium text-slate-600">{new Date(u.date_joined).toLocaleDateString()}</span>
                                        </div>
                                    </div>

                                    {/* Actions */}
                                    <div className="mt-auto grid grid-cols-2 gap-2 pt-4 border-t border-slate-100">
                                        <button
                                            onClick={() => toggleStatus(u.id)}
                                            className={`py-2 px-3 rounded-lg text-xs font-bold transition-colors border ${u.is_active ? 'border-red-100 text-red-600 hover:bg-red-50' : 'border-emerald-100 text-emerald-600 hover:bg-emerald-50'}`}
                                        >
                                            {u.is_active ? 'Deactivate' : 'Activate'}
                                        </button>
                                        <button
                                            onClick={() => handleDelete(u.id)}
                                            className="py-2 px-3 rounded-lg text-xs font-bold text-slate-400 hover:text-red-600 hover:bg-slate-50 transition-colors border border-transparent hover:border-slate-200"
                                        >
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        );
    };


    const CustomerManager = () => {
        const [customers, setCustomers] = useState([]);
        const [search, setSearch] = useState("");
        const [showModal, setShowModal] = useState(false);
        const [loading, setLoading] = useState(false);

        useEffect(() => { loadCustomers(); }, [search]);

        const loadCustomers = () => {
            setLoading(true);
            const query = search ? `?search=${search}` : '';
            api.get(`customers/${query}`).then(setCustomers).finally(() => setLoading(false));
        };

        const handleDelete = async (id, e) => {
            e.stopPropagation();
            if(!confirm("Delete customer? Only possible if no transaction history exists.")) return;
            try {
                await api.delete(`customers/${id}/`);
                notify("Customer Deleted");
                loadCustomers();
            } catch (err) { notify(err.message, 'error'); }
        };

        return (
            <div className="h-full flex flex-col gap-6 animate-fade-in relative">
                {showModal && <AddCustomerModal onClose={() => setShowModal(false)} onSuccess={() => { setShowModal(false); loadCustomers(); }}/>}

                {/* Header & Search */}
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div>
                        <h1 className="text-2xl font-bold text-slate-800">Customer Directory</h1>
                        <p className="text-sm text-slate-500">Manage client relationships and balances</p>
                    </div>
                    <div className="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                        <div className="relative flex-grow sm:w-64">
                            <i className="ph ph-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                            <input
                                placeholder="Search by name, phone..."
                                className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:border-brand-500 transition-all font-medium text-slate-600 bg-slate-50 focus:bg-white"
                                value={search}
                                onChange={e => setSearch(e.target.value)}
                            />
                        </div>
                        <Button onClick={() => setShowModal(true)} className="shadow-brand-200 whitespace-nowrap">
                            <i className="ph ph-user-plus text-lg"></i> <span className="hidden sm:inline">Add New</span>
                        </Button>
                    </div>
                </div>

                {/* Customer Grid */}
                <div className="flex-grow overflow-y-auto scroller -mx-2 px-2 pb-4">
                    {loading && customers.length === 0 ? (
                        <div className="p-10 text-center text-slate-400 flex flex-col items-center gap-2">
                            <i className="ph ph-spinner animate-spin text-2xl"></i> Loading directory...
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                            {customers.map(c => {
                                const balance = parseFloat(c.wallet_balance);
                                return (
                                    <div key={c.id} className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all group relative overflow-hidden flex flex-col">

                                        {/* Header Row */}
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-xl font-bold text-slate-500 border border-slate-200 shadow-sm">
                                                    {c.name.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <h3 className="font-bold text-slate-800 text-lg leading-tight line-clamp-1">{c.name}</h3>
                                                    <span className="text-xs text-slate-400 font-mono">ID: #{c.id}</span>
                                                </div>
                                            </div>
                                            <button
                                                onClick={(e) => handleDelete(c.id, e)}
                                                className="text-slate-300 hover:text-red-500 transition-colors p-2 hover:bg-red-50 rounded-full"
                                                title="Delete Customer"
                                            >
                                                <i className="ph ph-trash text-xl"></i>
                                            </button>
                                        </div>

                                        {/* Contact Details */}
                                        <div className="space-y-3 mb-4 flex-grow">
                                            <div className="flex items-center gap-3 text-sm text-slate-600">
                                                <div className="w-8 h-8 rounded-lg bg-slate-50 flex-shrink-0 flex items-center justify-center text-slate-400"><i className="ph ph-phone"></i></div>
                                                <span className="font-medium select-all">{c.phone}</span>
                                            </div>
                                            {c.email && (
                                                <div className="flex items-center gap-3 text-sm text-slate-600">
                                                    <div className="w-8 h-8 rounded-lg bg-slate-50 flex-shrink-0 flex items-center justify-center text-slate-400"><i className="ph ph-envelope"></i></div>
                                                    <span className="truncate select-all">{c.email}</span>
                                                </div>
                                            )}
                                            {c.address && (
                                                <div className="flex items-center gap-3 text-sm text-slate-600">
                                                    <div className="w-8 h-8 rounded-lg bg-slate-50 flex-shrink-0 flex items-center justify-center text-slate-400"><i className="ph ph-map-pin"></i></div>
                                                    <span className="truncate" title={c.address}>{c.address}</span>
                                                </div>
                                            )}
                                        </div>

                                        {/* Footer Stats */}
                                        <div className="pt-4 border-t border-slate-100 flex justify-between items-center bg-slate-50/50 -mx-5 -mb-5 px-5 py-3 mt-auto">
                                            <div className="flex flex-col">
                                                <span className="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Balance</span>
                                                <span className={`text-lg font-bold font-mono leading-none ${balance < 0 ? 'text-red-500' : balance > 0 ? 'text-emerald-600' : 'text-slate-700'}`}>
                                                    {formatCurrency(balance)}
                                                </span>
                                            </div>
                                            <div className="flex flex-col items-end">
                                                <span className="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Joined</span>
                                                <span className="text-sm font-medium text-slate-600 leading-none">{new Date(c.created_at).toLocaleDateString()}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {!loading && customers.length === 0 && (
                        <div className="flex flex-col items-center justify-center h-64 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">
                            <i className="ph ph-users-three text-4xl mb-2 opacity-30"></i>
                            <p className="font-medium">No customers found</p>
                            <p className="text-sm opacity-70">Add a new customer to get started.</p>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    // --- COMPONENT: SETTINGS MANAGER ---
   const SettingsManager = ({ onUpdate }) => {
        const [settings, setSettings] = useState({store_name: '', address: '', phone: '', email: ''});
        const [loading, setLoading] = useState(false);
        const [fetching, setFetching] = useState(true);

        useEffect(() => {
            api.get('settings/').then(data => {
                setSettings(data);
                setFetching(false);
            }).catch(() => setFetching(false));
        }, []);

        const save = async (e) => {
            e.preventDefault();
            setLoading(true);
            try {
                await api.post('settings/', settings);
                notify("Configuration Updated Successfully!");
                if (onUpdate) onUpdate(settings);
            } catch (e) { notify(e.message, 'error'); }
            finally { setLoading(false); }
        };

        if(fetching) return <div className="h-full flex items-center justify-center text-slate-400"><i className="ph ph-spinner animate-spin text-2xl"></i></div>;

        return (
            <div className="h-full flex flex-col gap-6 animate-fade-in max-w-4xl mx-auto w-full">
                <div className="text-center md:text-left">
                    <h1 className="text-2xl font-bold text-slate-800">Settings</h1>
                    <p className="text-slate-500">Manage your store identity and receipts</p>
                </div>

                <form onSubmit={save} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Store Identity */}
                    <Card className="flex flex-col gap-4 border-t-4 border-t-brand-500 shadow-md">
                        <div className="flex items-center gap-3 border-b border-slate-100 pb-3 mb-1">
                            <div className="p-2 bg-brand-50 text-brand-600 rounded-lg"><i className="ph ph-storefront text-xl"></i></div>
                            <div>
                                <h3 className="font-bold text-slate-700">Store Identity</h3>
                                <p className="text-xs text-slate-400">Name and branding</p>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Store Name</label>
                                <div className="relative">
                                    <i className="ph ph-tag absolute left-3 top-3 text-slate-400"></i>
                                    <input
                                        className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:border-brand-500 focus:ring-2 focus:ring-brand-50 transition-all font-medium text-slate-700"
                                        value={settings.store_name}
                                        onChange={e => setSettings({...settings, store_name: e.target.value})}
                                        required
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Address</label>
                                <div className="relative">
                                    <i className="ph ph-map-pin absolute left-3 top-3 text-slate-400"></i>
                                    <textarea
                                        className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:border-brand-500 focus:ring-2 focus:ring-brand-50 transition-all font-medium text-slate-700 min-h-[100px] resize-none"
                                        value={settings.address}
                                        onChange={e => setSettings({...settings, address: e.target.value})}
                                    />
                                </div>
                            </div>
                        </div>
                    </Card>

                    {/* Contact Info */}
                    <Card className="flex flex-col gap-4 border-t-4 border-t-emerald-500 shadow-md h-fit">
                        <div className="flex items-center gap-3 border-b border-slate-100 pb-3 mb-1">
                            <div className="p-2 bg-emerald-50 text-emerald-600 rounded-lg"><i className="ph ph-address-book text-xl"></i></div>
                            <div>
                                <h3 className="font-bold text-slate-700">Contact Details</h3>
                                <p className="text-xs text-slate-400">For receipts and invoices</p>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Phone Number</label>
                                <div className="relative">
                                    <i className="ph ph-phone absolute left-3 top-3 text-slate-400"></i>
                                    <input
                                        type="tel"
                                        className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-50 transition-all font-medium text-slate-700"
                                        value={settings.phone}
                                        onChange={e => setSettings({...settings, phone: e.target.value})}
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Email Address</label>
                                <div className="relative">
                                    <i className="ph ph-envelope absolute left-3 top-3 text-slate-400"></i>
                                    <input
                                        type="email"
                                        className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-50 transition-all font-medium text-slate-700"
                                        value={settings.email}
                                        onChange={e => setSettings({...settings, email: e.target.value})}
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="mt-4 pt-4 border-t border-slate-100">
                            <Button type="submit" disabled={loading} className="w-full py-3 text-sm bg-slate-800 hover:bg-slate-700 shadow-lg">
                                {loading ? <><i className="ph ph-spinner animate-spin"></i> Saving...</> : "Save Changes"}
                            </Button>
                        </div>
                    </Card>
                </form>
            </div>
        );
    };

    // --- UPDATED: POS TERMINAL (Responsive) ---
    const PosTerminal = () => {
        const [input, setInput] = useState("");
        const [scanQty, setScanQty] = useState(1);
        const [cart, setCart] = useState(() => {
            try {
                return JSON.parse(localStorage.getItem('pos_cart')) || []
            } catch {
                return []
            }
        });
        const [loading, setLoading] = useState(false);
        const [showCamera, setShowCamera] = useState(false);
        const [selectedCustomer, setSelectedCustomer] = useState(null);
        const [customerSearch, setCustomerSearch] = useState("");
        const [customers, setCustomers] = useState([]);
        const inputRef = useRef(null);

        useEffect(() => {
            localStorage.setItem('pos_cart', JSON.stringify(cart));
        }, [cart]);
        useEffect(() => {
            if (customerSearch.length > 2) api.get(`customers/?search=${customerSearch}`).then(setCustomers); else setCustomers([]);
        }, [customerSearch]);

        const handleScan = async (code) => {
            if (!code) return;
            setLoading(true);
            try {
                const p = await api.get(`scan/${code}/`);
                setCart(prev => {
                    const ex = prev.find(x => x.barcode === p.barcode);
                    return ex ? prev.map(x => x.barcode === p.barcode ? {
                        ...x,
                        qty: x.qty + scanQty
                    } : x) : [...prev, {...p, qty: scanQty}];
                });
                setInput("");
            } catch (e) {
                notify("Product Not Found", 'error');
            } finally {
                setLoading(false);
                setTimeout(() => inputRef.current?.focus(), 50);
            }
        };

        const checkout = async (method) => {
            if (!cart.length) return;
            if (method === 'debt' && !selectedCustomer) return notify("Select a customer for Debt payment", 'error');
            if (method === 'none' && !confirm("Create an Estimate? Inventory will NOT be deducted.")) return;
            setLoading(true);
            try {
                const payload = {
                    payment_method: method,
                    items: cart.map(i => ({barcode: i.barcode, quantity: i.qty})),
                    customer_id: selectedCustomer ? selectedCustomer.id : null,
                    is_quote: method === 'none'
                };
                const res = await api.post('purchase/', payload);
                if (method === 'none') {
                    notify("Estimate Created Successfully!");
                } else {
                    notify(`Order #${res.order_id} Paid: ${formatCurrency(res.total)}`);
                    const printUrl = `/print/receipt/${res.order_id}/`;
                    window.open(printUrl, 'Receipt', 'width=400,height=600,scrollbars=yes');
                }
                setCart([]);
                setSelectedCustomer(null);
                setCustomerSearch("");
            } catch (e) {
                notify(e.message, 'error');
            } finally {
                setLoading(false);
            }
        };

        const updateQty = (barcode, newQty) => {
            if (newQty < 1) return;
            setCart(cart.map(i => i.barcode === barcode ? {...i, qty: parseInt(newQty)} : i));
        };
        const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);

        return (
            <div
                className="h-full flex flex-col md:flex-row gap-6 animate-fade-in overflow-y-auto scroller pb-20 md:pb-0">
                {showCamera && <CameraModal onScan={(c) => {
                    setShowCamera(false);
                    handleScan(c);
                    notify("Scanned!");
                }} onClose={() => setShowCamera(false)}/>}
                <div className="flex-grow flex flex-col gap-4 min-h-[500px]">
                    <div
                        className="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200 flex gap-4 items-center sticky top-0 z-20">
                        <div className="flex flex-col gap-1 w-16 md:w-24"><label
                            className="text-xs font-bold text-slate-400">QTY</label><input type="number" min="1"
                                                                                           value={scanQty}
                                                                                           onChange={e => setScanQty(Math.max(1, parseInt(e.target.value) || 1))}
                                                                                           className="w-full text-xl font-bold text-center outline-none border-b-2 border-brand-500"/>
                        </div>
                        <div className="h-10 w-px bg-slate-200 mx-2"></div>
                        <i className="ph ph-barcode text-4xl text-slate-300 hidden md:block"></i>
                        <input ref={inputRef} value={input} onChange={e => setInput(e.target.value)}
                               onKeyDown={e => e.key === 'Enter' && handleScan(input.trim())}
                               className="w-full text-lg md:text-2xl outline-none font-mono placeholder:text-slate-300"
                               placeholder="Scan..." autoFocus/>
                        <Button variant="dark" onClick={() => setShowCamera(true)} className="px-3 md:px-4 h-12"><i
                            className="ph ph-camera text-xl"></i> <span
                            className="hidden md:inline">Scan</span></Button>
                    </div>
                    <Card className="flex-grow p-0 overflow-hidden flex flex-col border-0 shadow-md">
                        <div
                            className="p-4 bg-slate-50 border-b font-bold text-xs text-slate-500 uppercase flex tracking-wider">
                            <span className="flex-grow">Item</span><span className="w-24 text-center">Qty</span><span
                            className="w-20 text-right">Price</span><span className="w-10"></span></div>
                        <div className="flex-grow overflow-auto p-2 space-y-1 bg-white min-h-[300px]">
                            {cart.map(i => (
                                <div key={i.barcode}
                                     className="flex items-center p-3 hover:bg-slate-50 rounded-lg group transition-colors">
                                    <div className="flex-grow font-bold text-slate-700 text-sm">{i.product_name} <span
                                        className="block text-xs text-slate-400 font-normal">{i.sku}</span></div>
                                    <div className="w-24 flex items-center justify-center gap-2">
                                        <button onClick={() => updateQty(i.barcode, i.qty - 1)}
                                                className="w-6 h-6 flex items-center justify-center bg-slate-100 rounded hover:bg-slate-200 text-slate-600">-
                                        </button>
                                        <span className="w-6 text-center font-bold text-sm">{i.qty}</span>
                                        <button onClick={() => updateQty(i.barcode, i.qty + 1)}
                                                className="w-6 h-6 flex items-center justify-center bg-slate-100 rounded hover:bg-slate-200 text-slate-600">+
                                        </button>
                                    </div>
                                    <div
                                        className="w-20 text-right font-mono text-slate-600 text-sm">{formatCurrency(i.price * i.qty)}</div>
                                    <button onClick={() => setCart(cart.filter(x => x.barcode !== i.barcode))}
                                            className="w-10 text-slate-300 hover:text-red-500"><i
                                        className="ph ph-trash text-xl"></i></button>
                                </div>
                            ))}
                        </div>
                    </Card>
                </div>
                <div className="w-full md:w-80 flex flex-col gap-4">
                    <Card className="border-none shadow-xl bg-white">
                        <div className="mb-4 relative">
                            <label className="text-xs font-bold text-slate-400 uppercase block mb-1">Customer
                                (Optional)</label>
                            {selectedCustomer ? (
                                <div
                                    className="p-3 bg-brand-50 border border-brand-200 rounded-lg flex justify-between items-center">
                                    <div>
                                        <div className="font-bold text-brand-700">{selectedCustomer.name}</div>
                                        <div className="text-xs text-brand-500">{selectedCustomer.phone}</div>
                                    </div>
                                    <button onClick={() => {
                                        setSelectedCustomer(null);
                                        setCustomerSearch("")
                                    }} className="text-brand-400 hover:text-brand-600"><i
                                        className="ph ph-x-circle text-xl"></i></button>
                                </div>
                            ) : (
                                <div>
                                    <input className="w-full p-2 border rounded" placeholder="Search customer..."
                                           value={customerSearch} onChange={e => setCustomerSearch(e.target.value)}/>
                                    {customers.length > 0 && (
                                        <div
                                            className="absolute left-0 right-0 bg-white shadow-xl border rounded mt-1 z-50 max-h-48 overflow-auto">
                                            {customers.map(c => (<div key={c.id} onClick={() => {
                                                setSelectedCustomer(c);
                                                setCustomers([])
                                            }} className="p-2 hover:bg-slate-50 cursor-pointer border-b text-sm">
                                                <div className="font-bold">{c.name}</div>
                                                <div className="text-xs text-slate-500">{c.phone}</div>
                                            </div>))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                        <div className="border-t pt-4">
                            <div className="text-slate-400 text-xs font-bold uppercase tracking-widest">Total Due</div>
                            <div
                                className="text-4xl font-mono font-bold mt-1 tracking-tight text-slate-800">{formatCurrency(total)}</div>
                        </div>
                        <div className="grid grid-cols-2 gap-2 mt-6">
                            <Button onClick={() => checkout('cash')} disabled={!cart.length || loading}
                                    className="col-span-1 py-4 text-lg bg-emerald-600 hover:bg-emerald-500 shadow-lg shadow-emerald-900/50">CASH</Button>
                            <Button onClick={() => checkout('card')} disabled={!cart.length || loading}
                                    className="col-span-1 py-3 bg-blue-600 hover:bg-blue-500">CARD</Button>

                            {/* Logic: If Customer is selected, Transfer shares row with Debt. If not, Transfer is full width. */}
                            <Button onClick={() => checkout('transfer')} disabled={!cart.length || loading}
                                    className={`${selectedCustomer ? 'col-span-1' : 'col-span-2'} py-3 bg-purple-600 hover:bg-purple-500`}>TRANSFER</Button>

                            {selectedCustomer && (
                                <Button onClick={() => checkout('debt')} disabled={!cart.length || loading}
                                        className="col-span-1 py-3 bg-slate-700 hover:bg-slate-600 border border-slate-600">PAY
                                    LATER</Button>
                            )}

                            <Button onClick={() => checkout('none')} disabled={!cart.length || loading}
                                    className="col-span-2 py-3 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-indigo-200 font-bold tracking-wide mt-2">
                                <i className="ph ph-file-text mr-2"></i> Create Estimate
                            </Button>
                        </div>
                    </Card>
                </div>
            </div>
        );
    };

    const OrderHistory = () => {
        const [orders, setOrders] = useState([]);
        const [selectedOrder, setSelectedOrder] = useState(null);
        const [filter, setFilter] = useState('all');
        const [search, setSearch] = useState("");
        const [page, setPage] = useState(1);
        const PER_PAGE = 15;

        useEffect(() => {
            loadOrders();
        }, [filter]);

        const loadOrders = () => {
            const q = filter !== 'all' ? `?status=${filter}` : '';
            api.get(`orders/${q}`).then(res => {
                setOrders(res);
                setPage(1);
            });
        };

        const filteredOrders = useMemo(() => {
            if (!search) return orders;
            const lower = search.toLowerCase();
            return orders.filter(o =>
                o.id.toString().includes(lower) ||
                (o.customer_name && o.customer_name.toLowerCase().includes(lower)) ||
                o.cashier_name.toLowerCase().includes(lower)
            );
        }, [orders, search]);

        const paginatedOrders = useMemo(() => {
            const start = (page - 1) * PER_PAGE;
            return filteredOrders.slice(start, start + PER_PAGE);
        }, [filteredOrders, page]);

        const deleteOrder = async (id, e) => {
            e.stopPropagation();
            if (!confirm("Permanently delete this quote?")) return;
            try {
                await api.delete(`orders/${id}/`);
                notify("Quote Deleted");
                setOrders(prev => prev.filter(o => o.id !== id));
                if (selectedOrder?.id === id) setSelectedOrder(null);
            } catch (e) {
                notify(e.message, 'error');
            }
        };

        const printReceipt = (id, e) => {
            e.stopPropagation();
            const printUrl = `/print/receipt/${id}/`;
            window.open(printUrl, 'Receipt', 'width=400,height=600,scrollbars=yes');
        };

        // --- SUB-COMPONENT: ORDER DETAIL & REFUND PANEL ---
        const OrderDetailPanel = ({order, onClose}) => {
            const [refundData, setRefundData] = useState({});
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const initial = {};
                order.items.forEach(i => initial[i.id] = {qty: 0, damaged: false});
                setRefundData(initial);
            }, [order]);

            const handleQty = (id, v, max) => {
                const val = Math.min(Math.max(0, parseInt(v) || 0), max);
                setRefundData(p => ({...p, [id]: {...p[id], qty: val}}));
            };

            const toggleDmg = (id) => setRefundData(p => ({...p, [id]: {...p[id], damaged: !p[id].damaged}}));

            const submitRefund = async () => {
                const items = order.items.map(i => ({
                    barcode: i.barcode,
                    quantity: refundData[i.id]?.qty || 0,
                    is_damaged: refundData[i.id]?.dmg || false
                })).filter(i => i.quantity > 0);

                if (!items.length) return notify("Select items to return first", 'error');

                setLoading(true);
                try {
                    await api.post('refund/', {order_id: order.id, items});
                    notify("Refund Processed Successfully");
                    onClose(true); // Refresh list
                } catch (e) {
                    notify(e.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const refundTotal = order.items.reduce((acc, i) => acc + (parseFloat(i.unit_price) * (refundData[i.id]?.qty || 0)), 0);

            return (
                <div
                    className="h-full flex flex-col bg-white md:rounded-xl shadow-xl overflow-hidden border-l border-slate-100 animate-fade-in">
                    {/* Invoice Header */}
                    <div className="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-start">
                        <div>
                            <div className="flex items-center gap-2 mb-1">
                                <h2 className="text-2xl font-bold text-slate-800">Order #{order.id}</h2>
                                <StatusBadge status={order.status}/>
                            </div>
                            <p className="text-sm text-slate-500 flex items-center gap-2">
                                <i className="ph ph-calendar"></i> {new Date(order.created_at).toLocaleString()}
                            </p>
                            <p className="text-sm text-slate-500 flex items-center gap-2 mt-1">
                                <i className="ph ph-user"></i> {order.customer_name || 'Walk-in Customer'}
                            </p>
                        </div>
                        <button onClick={() => onClose(false)}
                                className="p-2 hover:bg-slate-200 rounded-full transition-colors text-slate-500">
                            <i className="ph ph-x text-xl"></i>
                        </button>
                    </div>

                    {/* Scrollable Items List */}
                    <div className="flex-grow overflow-y-auto p-6 space-y-4 scroller">
                        {order.items.map(item => {
                            const eligible = item.quantity - item.refunded_quantity;
                            const cur = refundData[item.id] || {qty: 0};

                            return (
                                <div key={item.id}
                                     className={`flex flex-col p-4 rounded-xl border transition-all ${eligible > 0 ? 'border-slate-200 bg-white' : 'border-slate-100 bg-slate-50 opacity-70'}`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <p className="font-bold text-slate-700">{item.product_name}</p>
                                            <p className="text-xs text-slate-400 font-mono">{item.sku}</p>
                                        </div>
                                        <p className="font-mono font-medium text-slate-600">{formatCurrency(item.unit_price)}</p>
                                    </div>

                                    <div className="flex justify-between items-center text-sm mb-3">
                                        <span
                                            className="text-slate-500 bg-slate-100 px-2 py-1 rounded">Qty: {item.quantity}</span>
                                        {item.refunded_quantity > 0 && <span
                                            className="text-red-600 bg-red-50 px-2 py-1 rounded border border-red-100">Returned: {item.refunded_quantity}</span>}
                                    </div>

                                    {/* Refund Controls */}
                                    {order.status === 'completed' && eligible > 0 && (
                                        <div
                                            className="bg-slate-50 p-3 rounded-lg border border-slate-100 flex items-center gap-4 mt-2">
                                            <div
                                                className="flex items-center gap-2 bg-white border rounded-lg p-1 shadow-sm">
                                                <button onClick={() => handleQty(item.id, cur.qty - 1, eligible)}
                                                        className="w-8 h-8 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600 font-bold">-
                                                </button>
                                                <input
                                                    className="w-12 text-center font-bold outline-none text-slate-700"
                                                    value={cur.qty} readOnly/>
                                                <button onClick={() => handleQty(item.id, cur.qty + 1, eligible)}
                                                        className="w-8 h-8 flex items-center justify-center hover:bg-slate-100 rounded text-slate-600 font-bold">+
                                                </button>
                                            </div>
                                            <div className="flex-grow">
                                                <label
                                                    className="flex items-center gap-2 cursor-pointer text-xs font-bold text-slate-500 hover:text-red-500 transition-colors">
                                                    <input type="checkbox" checked={cur.damaged}
                                                           onChange={() => toggleDmg(item.id)}
                                                           className="rounded text-red-500 focus:ring-red-500"/>
                                                    Mark Damaged
                                                </label>
                                            </div>
                                            {cur.qty > 0 && <span
                                                className="font-bold text-red-600 text-sm">-{formatCurrency(cur.qty * item.unit_price)}</span>}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    {/* Footer Actions */}
                    <div className="p-6 bg-slate-50 border-t border-slate-200">
                        {order.status === 'completed' ? (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center text-sm">
                                    <span
                                        className="text-slate-500 font-medium uppercase tracking-wide">Refund Total</span>
                                    <span
                                        className="text-2xl font-bold text-red-600">{formatCurrency(refundTotal)}</span>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <Button variant="ghost" className="bg-white border border-slate-200 shadow-sm"
                                            onClick={(e) => printReceipt(order.id, e)}>
                                        <i className="ph ph-printer text-lg"></i> Reprint
                                    </Button>
                                    <Button variant="danger" disabled={refundTotal <= 0 || loading}
                                            onClick={submitRefund} className="shadow-red-500/20">
                                        {loading ? <i className="ph ph-spinner animate-spin"></i> : "Confirm Refund"}
                                    </Button>
                                </div>
                            </div>
                        ) : (
                            <div className="flex gap-3">
                                <Button variant="ghost" className="w-full bg-white border"
                                        onClick={(e) => printReceipt(order.id, e)}>Print</Button>
                                <Button className="w-full" onClick={() => onClose(false)}>Close View</Button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        return (
            <div className="h-full flex flex-col md:flex-row gap-6 animate-fade-in relative">

                {/* LIST SECTION */}
                <div
                    className={`flex-col gap-4 h-full flex transition-all duration-300 ${selectedOrder ? 'hidden md:flex md:w-1/2 lg:w-5/12' : 'w-full'}`}>
                    {/* Header & Search */}
                    <div className="flex flex-col gap-4">
                        <div className="flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-slate-800">Orders</h1>
                            <div className="flex bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                                {['all', 'completed', 'quote', 'refunded'].map(f => (
                                    <button key={f} onClick={() => setFilter(f)}
                                            className={`px-3 py-1.5 text-xs font-bold uppercase rounded-md transition-all ${filter === f ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:bg-slate-50'}`}>
                                        {f}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="relative">
                            <i className="ph ph-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                            <input
                                className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:border-brand-500 transition-all bg-white shadow-sm"
                                placeholder="Search by ID, Customer or Cashier..." value={search}
                                onChange={e => setSearch(e.target.value)}/>
                        </div>
                    </div>

                    {/* Orders Table */}
                    <Card className="flex-grow p-0 overflow-hidden flex flex-col border-0 shadow-md">
                        <div className="overflow-auto scroller h-full">
                            <table className="w-full text-left text-sm min-w-[500px]">
                                <thead
                                    className="bg-slate-50 font-bold border-b text-slate-500 sticky top-0 z-10 text-xs uppercase tracking-wide">
                                <tr>
                                    <th className="p-4">Order</th>
                                    <th className="p-4">Status</th>
                                    <th className="p-4 text-right">Total</th>
                                    <th className="p-4 w-12"></th>
                                </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100 bg-white">
                                {paginatedOrders.map(o => (
                                    <tr key={o.id} onClick={() => setSelectedOrder(o)}
                                        className={`group cursor-pointer transition-colors ${selectedOrder?.id === o.id ? 'bg-blue-50' : 'hover:bg-slate-50'}`}>
                                        <td className="p-4">
                                            <div
                                                className="font-bold text-slate-700 group-hover:text-brand-600 transition-colors">#{o.id}</div>
                                            <div
                                                className="text-xs text-slate-400 mt-0.5">{new Date(o.created_at).toLocaleDateString()} • {o.cashier_name}</div>
                                        </td>
                                        <td className="p-4"><StatusBadge status={o.status}/></td>
                                        <td className="p-4 text-right font-mono font-bold text-slate-700">{formatCurrency(o.total_amount)}</td>
                                        <td className="p-4 text-right">
                                            <div
                                                className="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                {o.status === 'completed' && (
                                                    <button onClick={(e) => printReceipt(o.id, e)}
                                                            className="p-2 text-slate-400 hover:text-brand-600 hover:bg-brand-50 rounded-full"
                                                            title="Reprint">
                                                        <i className="ph ph-printer text-lg"></i>
                                                    </button>
                                                )}
                                                {(o.status === 'quote' || o.status === 'pending') && (
                                                    <button onClick={(e) => deleteOrder(o.id, e)}
                                                            className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-full"
                                                            title="Delete">
                                                        <i className="ph ph-trash text-lg"></i>
                                                    </button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {paginatedOrders.length === 0 && (
                                    <tr>
                                        <td colSpan="4" className="p-8 text-center text-slate-400 italic">No orders
                                            found.
                                        </td>
                                    </tr>
                                )}
                                </tbody>
                            </table>
                        </div>
                        <div className="border-t p-2 bg-slate-50"><Pagination total={filteredOrders.length} page={page}
                                                                              setPage={setPage} perPage={PER_PAGE}/>
                        </div>
                    </Card>
                </div>

                {/* DETAIL SECTION (Mobile Overlay / Desktop Side Panel) */}
                {selectedOrder && (
                    <div
                        className="fixed inset-0 z-50 md:static md:z-0 md:flex-grow h-full bg-slate-900/20 backdrop-blur-sm md:backdrop-blur-none md:bg-transparent flex justify-end animate-fade-in">
                        <div
                            className="w-full md:w-auto md:flex-grow h-full max-w-lg bg-white shadow-2xl md:shadow-none">
                            <OrderDetailPanel order={selectedOrder} onClose={(refresh) => {
                                setSelectedOrder(null);
                                if (refresh) loadOrders();
                            }}/>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const SalesLedger = () => {
        const [data, setData] = useState({total_revenue: 0, breakdown: [], orders: []});
        const [dateRange, setDateRange] = useState({
            start: new Date().toISOString().split('T')[0],
            end: new Date().toISOString().split('T')[0]
        });
        const [loading, setLoading] = useState(false);

        useEffect(() => {
            loadReport();
        }, []);

        const loadReport = async () => {
            setLoading(true);
            try {
                const res = await api.get(`reports/sales/?start=${dateRange.start}&end=${dateRange.end}`);
                setData(res);
            } catch (e) {
                notify(e.message, 'error');
            } finally {
                setLoading(false);
            }
        };

        // Calculations for KPIs
        const revenue = parseFloat(data.total_revenue || 0);
        const count = data.orders.length;
        const avgOrder = count > 0 ? revenue / count : 0;

        return (
            <div className="h-full flex flex-col gap-6 animate-fade-in">
                {/* Header & Filters */}
                <div
                    className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div>
                        <h1 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <i className="ph ph-receipt text-brand-600"></i> Sales Ledger
                        </h1>
                        <p className="text-xs text-slate-500">Financial records
                            from {dateRange.start} to {dateRange.end}</p>
                    </div>

                    <div
                        className="flex items-center gap-2 bg-slate-50 p-1 rounded-lg border overflow-x-auto max-w-full">
                        <input type="date"
                               className="p-2 text-sm bg-transparent outline-none font-medium text-slate-600"
                               value={dateRange.start}
                               onChange={e => setDateRange({...dateRange, start: e.target.value})}/>
                        <span className="text-slate-400">to</span>
                        <input type="date"
                               className="p-2 text-sm bg-transparent outline-none font-medium text-slate-600"
                               value={dateRange.end} onChange={e => setDateRange({...dateRange, end: e.target.value})}/>
                        <Button size="sm" onClick={loadReport} disabled={loading} className="px-4 shrink-0 shadow-none">
                            {loading ? <i className="ph ph-spinner animate-spin"></i> : "Filter"}
                        </Button>
                    </div>
                </div>

                {/* KPI Summary Strip */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <Card className="flex items-center justify-between p-5 border-l-4 border-l-emerald-500 shadow-sm">
                        <div>
                            <div className="text-xs font-bold uppercase text-slate-400 tracking-wider">Total Revenue
                            </div>
                            <div
                                className="text-2xl font-mono font-bold text-slate-800 mt-1">{formatCurrency(revenue)}</div>
                        </div>
                        <div
                            className="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600">
                            <i className="ph ph-currency-dollar text-xl"></i>
                        </div>
                    </Card>

                    <Card className="flex items-center justify-between p-5 border-l-4 border-l-blue-500 shadow-sm">
                        <div>
                            <div className="text-xs font-bold uppercase text-slate-400 tracking-wider">Transactions
                            </div>
                            <div className="text-2xl font-bold text-slate-800 mt-1">{count}</div>
                        </div>
                        <div
                            className="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                            <i className="ph ph-shopping-cart text-xl"></i>
                        </div>
                    </Card>

                    <Card className="flex items-center justify-between p-5 border-l-4 border-l-purple-500 shadow-sm">
                        <div>
                            <div className="text-xs font-bold uppercase text-slate-400 tracking-wider">Avg. Order
                                Value
                            </div>
                            <div
                                className="text-2xl font-mono font-bold text-slate-800 mt-1">{formatCurrency(avgOrder)}</div>
                        </div>
                        <div
                            className="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-600">
                            <i className="ph ph-chart-line-up text-xl"></i>
                        </div>
                    </Card>
                </div>

                {/* Main Table */}
                <Card className="flex-grow p-0 overflow-hidden flex flex-col border border-slate-200 shadow-md">
                    <div className="overflow-auto scroller h-full bg-white">
                        <table className="w-full text-left text-sm min-w-[700px]">
                            <thead
                                className="bg-slate-50 font-bold border-b text-slate-500 sticky top-0 z-10 text-xs uppercase tracking-wide">
                            <tr>
                                <th className="p-4">Date & Time</th>
                                <th className="p-4">Order ID</th>
                                <th className="p-4">Customer</th>
                                <th className="p-4">Cashier</th>
                                <th className="p-4">Payment</th>
                                <th className="p-4 text-right">Amount</th>
                            </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                            {data.orders.length === 0 ? (
                                <tr>
                                    <td colSpan="6" className="p-12 text-center text-slate-400 italic">No records found
                                        for this period.
                                    </td>
                                </tr>
                            ) : (
                                data.orders.map(o => (
                                    <tr key={o.id} className="hover:bg-slate-50 transition-colors group">
                                        <td className="p-4 text-slate-500 whitespace-nowrap">
                                            <div
                                                className="font-medium text-slate-700">{new Date(o.created_at).toLocaleDateString()}</div>
                                            <div className="text-xs">{new Date(o.created_at).toLocaleTimeString()}</div>
                                        </td>
                                        <td className="p-4 font-mono text-xs font-bold text-slate-600 group-hover:text-brand-600 transition-colors">#{o.id}</td>
                                        <td className="p-4">
                                            {o.customer_name ? (
                                                <span className="font-medium text-slate-700">{o.customer_name}</span>
                                            ) : (
                                                <span className="text-slate-400 italic text-xs">Walk-in</span>
                                            )}
                                        </td>
                                        <td className="p-4 text-slate-600 text-xs">{o.cashier_name}</td>
                                        <td className="p-4">
                                                <span
                                                    className={`text-[10px] uppercase font-bold px-2 py-1 rounded border ${
                                                        o.payment_method === 'cash' ? 'bg-green-50 text-green-700 border-green-100' :
                                                            o.payment_method === 'transfer' ? 'bg-purple-50 text-purple-700 border-purple-100' :
                                                                'bg-blue-50 text-blue-700 border-blue-100'
                                                    }`}>
                                                    {o.payment_method}
                                                </span>
                                        </td>
                                        <td className="p-4 text-right font-mono font-bold text-slate-800">{formatCurrency(parseFloat(o.total_amount))}</td>
                                    </tr>
                                ))
                            )}
                            </tbody>
                        </table>
                    </div>
                </Card>
            </div>
        );
    };


    const StocktakeManager = () => {
        const [sessions, setSessions] = useState([]);
        const [activeSession, setActiveSession] = useState(null);
        const [loading, setLoading] = useState(false);

        useEffect(() => {
            loadSessions();
        }, []);

        const loadSessions = () => {
            setLoading(true);
            api.get('stocktake/').then(setSessions).finally(() => setLoading(false));
        };

        const startSession = async () => {
            const note = prompt("Session Note (e.g., 'End of The Year Audit'):");
            if (note === null) return;
            try {
                const res = await api.post('stocktake/', {note});
                notify("Session Started");
                loadSessions();
                api.get(`stocktake/${res.id}/`).then(setActiveSession);
            } catch (e) {
                notify(e.message, 'error');
            }
        };

        const deleteSession = async (id, e) => {
            e.stopPropagation();
            if (!confirm("Discard this draft session?")) return;
            try {
                await api.delete(`stocktake/${id}/`);
                notify("Session Discarded");
                setSessions(prev => prev.filter(s => s.id !== id));
            } catch (e) {
                notify(e.message, 'error');
            }
        };

        // --- SUB-COMPONENT: ACTIVE SESSION WORKSPACE ---
        const SessionWorkspace = ({session, onClose}) => {
            const [items, setItems] = useState(session.items || []);
            const [filter, setFilter] = useState('');
            const [scanMode, setScanMode] = useState('increment'); // 'increment' or 'set'
            const [showCamera, setShowCamera] = useState(false);
            const [inputCode, setInputCode] = useState("");
            const inputRef = useRef(null);

            // Focus scan input on load
            useEffect(() => {
                setTimeout(() => inputRef.current?.focus(), 100);
            }, []);

            // Calculated Stats
            const stats = useMemo(() => {
                const total = items.length;
                const counted = items.filter(i => i.counted_quantity > 0).length;
                const matched = items.filter(i => i.counted_quantity === i.expected_quantity).length;
                const variance = items.reduce((acc, i) => acc + (i.counted_quantity - i.expected_quantity), 0);
                return {total, counted, matched, variance};
            }, [items]);

            const handleScan = (code) => {
                if (!code) return;
                const item = items.find(i => i.barcode === code);
                if (!item) return notify("Item not found in inventory list", 'error');

                const newQty = item.counted_quantity + 1;
                updateItem(item, newQty);
                setInputCode("");
                notify(`Counted: ${item.product_name}`);
            };

            const updateItem = async (item, qty) => {
                // Optimistic UI update
                const newItems = items.map(i => i.id === item.id ? {...i, counted_quantity: parseInt(qty)} : i);
                setItems(newItems);

                try {
                    await api.post(`stocktake/${session.id}/`, {barcode: item.barcode, quantity: parseInt(qty)});
                } catch (e) {
                    notify("Save failed", 'error');
                    // Revert? For now, we trust the user will retry or refresh if connection fails.
                }
            };

            const finalize = async () => {
                if (!confirm("Finalize Stocktake? This will overwrite live inventory stock levels.")) return;
                try {
                    await api.put(`stocktake/${session.id}/`, {});
                    notify("Inventory Updated Successfully!");
                    onClose();
                } catch (e) {
                    notify(e.message, 'error');
                }
            };

            const filteredItems = items.filter(i =>
                i.product_name.toLowerCase().includes(filter.toLowerCase()) ||
                i.barcode.includes(filter) ||
                i.sku.toLowerCase().includes(filter)
            );

            return (
                <div className="fixed inset-0 z-50 bg-slate-100 flex flex-col animate-fade-in">
                    {showCamera && <CameraModal onScan={(c) => {
                        setShowCamera(false);
                        handleScan(c);
                    }} onClose={() => setShowCamera(false)}/>}

                    {/* Workspace Header */}
                    <div
                        className="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm z-20">
                        <div className="flex items-center gap-4">
                            <button onClick={onClose}
                                    className="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-500">
                                <i className="ph ph-arrow-left text-xl"></i>
                            </button>
                            <div>
                                <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    Stocktake #{session.id}
                                    <span
                                        className={`px-2 py-0.5 text-[10px] rounded-full uppercase tracking-wider ${session.status === 'in_progress' ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}`}>
                                        {session.status.replace('_', ' ')}
                                    </span>
                                </h2>
                                <p className="text-xs text-slate-500">{formatDate(session.created_at)} • {session.note || 'No notes'}</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            {session.status === 'in_progress' && (
                                <Button onClick={finalize}
                                        className="bg-slate-800 hover:bg-slate-700 text-white shadow-lg">
                                    <i className="ph ph-check-circle"></i> <span
                                    className="hidden sm:inline">Finalize</span>
                                </Button>
                            )}
                        </div>
                    </div>

                    {/* Stats Strip */}
                    <div className="grid grid-cols-4 gap-px bg-slate-200 border-b border-slate-200">
                        <div className="bg-white p-3 text-center">
                            <div className="text-[10px] uppercase text-slate-400 font-bold">Progress</div>
                            <div
                                className="text-lg font-bold text-slate-700">{Math.round((stats.counted / stats.total) * 100)}%
                            </div>
                        </div>
                        <div className="bg-white p-3 text-center">
                            <div className="text-[10px] uppercase text-slate-400 font-bold">Counted</div>
                            <div className="text-lg font-bold text-brand-600">{stats.counted}/{stats.total}</div>
                        </div>
                        <div className="bg-white p-3 text-center">
                            <div className="text-[10px] uppercase text-slate-400 font-bold">Matched</div>
                            <div className="text-lg font-bold text-emerald-600">{stats.matched}</div>
                        </div>
                        <div className="bg-white p-3 text-center">
                            <div className="text-[10px] uppercase text-slate-400 font-bold">Net Var</div>
                            <div
                                className={`text-lg font-bold ${stats.variance === 0 ? 'text-slate-400' : stats.variance < 0 ? 'text-red-500' : 'text-emerald-500'}`}>
                                {stats.variance > 0 ? '+' : ''}{stats.variance}
                            </div>
                        </div>
                    </div>

                    {/* Scanner & Filter Toolbar */}
                    {session.status === 'in_progress' && (
                        <div
                            className="bg-white p-3 border-b border-slate-200 flex flex-col sm:flex-row gap-3 shadow-sm z-10">
                            <div
                                className="flex-grow flex items-center gap-2 bg-slate-100 p-1.5 rounded-lg border border-slate-200 focus-within:border-brand-500 focus-within:ring-2 focus-within:ring-brand-100 transition-all">
                                <i className="ph ph-barcode text-xl text-slate-400 ml-2"></i>
                                <input
                                    ref={inputRef}
                                    value={inputCode}
                                    onChange={e => setInputCode(e.target.value)}
                                    onKeyDown={e => e.key === 'Enter' && handleScan(inputCode)}
                                    className="bg-transparent outline-none flex-grow text-sm font-medium"
                                    placeholder="Scan barcode..."
                                    autoComplete="off"
                                />
                                <button onClick={() => setShowCamera(true)}
                                        className="p-1.5 bg-white rounded border shadow-sm text-slate-600 hover:text-brand-600">
                                    <i className="ph ph-camera text-lg"></i>
                                </button>
                            </div>
                            <div className="w-full sm:w-64">
                                <input
                                    value={filter}
                                    onChange={e => setFilter(e.target.value)}
                                    className="w-full p-2.5 text-sm bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-brand-500"
                                    placeholder="Filter by name, sku..."
                                />
                            </div>
                        </div>
                    )}

                    {/* Main List */}
                    <div className="flex-grow overflow-y-auto scroller p-2 sm:p-4">
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-50 font-bold text-slate-500 border-b">
                                <tr>
                                    <th className="p-3 pl-4">Product</th>
                                    <th className="p-3 text-center w-24">System</th>
                                    <th className="p-3 text-center w-32">Counted</th>
                                    <th className="p-3 text-right pr-4 w-24">Var</th>
                                </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                {filteredItems.map(item => {
                                    const variance = item.counted_quantity - item.expected_quantity;
                                    const isMatched = variance === 0 && item.counted_quantity > 0;
                                    const isPending = item.counted_quantity === 0;

                                    return (
                                        <tr key={item.id}
                                            className={`hover:bg-slate-50 transition-colors ${isMatched ? 'bg-emerald-50/30' : variance !== 0 ? 'bg-red-50/30' : ''}`}>
                                            <td className="p-3 pl-4">
                                                <div className="font-bold text-slate-700">{item.product_name}</div>
                                                <div className="text-xs text-slate-400 font-mono flex gap-2">
                                                    <span>{item.sku}</span>
                                                    <span className="text-slate-300">•</span>
                                                    <span>{item.barcode}</span>
                                                </div>
                                            </td>
                                            <td className="p-3 text-center text-slate-500 font-mono">
                                                {item.expected_quantity}
                                            </td>
                                            <td className="p-3 text-center">
                                                {session.status === 'in_progress' ? (
                                                    <div className="flex items-center justify-center gap-1">
                                                        <button
                                                            onClick={() => updateItem(item, Math.max(0, item.counted_quantity - 1))}
                                                            className="w-7 h-7 flex items-center justify-center rounded bg-slate-100 hover:bg-slate-200 text-slate-600 transition-colors">-
                                                        </button>
                                                        <input
                                                            className={`w-12 text-center font-bold border rounded py-1 text-sm outline-none focus:border-brand-500 ${variance !== 0 ? 'text-brand-600 border-brand-200' : 'text-slate-700'}`}
                                                            value={item.counted_quantity}
                                                            onChange={(e) => {
                                                                const val = e.target.value;
                                                                if (val === '' || /^\d+$/.test(val)) {
                                                                    updateItem(item, val === '' ? 0 : parseInt(val));
                                                                }
                                                            }}
                                                            onFocus={(e) => e.target.select()}
                                                        />
                                                        <button
                                                            onClick={() => updateItem(item, item.counted_quantity + 1)}
                                                            className="w-7 h-7 flex items-center justify-center rounded bg-slate-100 hover:bg-slate-200 text-slate-600 transition-colors">+
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <span
                                                        className="font-bold text-slate-800">{item.counted_quantity}</span>
                                                )}
                                            </td>
                                            <td className="p-3 text-right pr-4">
                                                    <span
                                                        className={`font-mono font-bold ${variance === 0 ? 'text-slate-300' : variance > 0 ? 'text-emerald-600' : 'text-red-500'}`}>
                                                        {variance > 0 ? '+' : ''}{variance}
                                                    </span>
                                            </td>
                                        </tr>
                                    );
                                })}
                                </tbody>
                            </table>
                            {filteredItems.length === 0 &&
                                <div className="p-8 text-center text-slate-400">No items match your search.</div>}
                        </div>
                    </div>
                </div>
            );
        };

        return (
            <div className="h-full flex flex-col gap-6 animate-fade-in relative">
                {activeSession && <SessionWorkspace session={activeSession} onClose={() => {
                    setActiveSession(null);
                    loadSessions();
                }}/>}

                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 className="text-2xl font-bold text-slate-800">Stocktake</h1>
                        <p className="text-slate-500 text-sm">Audit inventory levels</p>
                    </div>
                    <Button onClick={startSession} className="shadow-brand-200"><i
                        className="ph ph-plus-circle"></i> New Session</Button>
                </div>

                <Card className="flex-grow p-0 overflow-hidden flex flex-col border-0 shadow-md bg-white">
                    <div className="overflow-auto scroller h-full">
                        <table className="w-full text-left text-sm min-w-[600px]">
                            <thead
                                className="bg-slate-50 font-bold border-b sticky top-0 text-slate-500 z-10 text-xs uppercase tracking-wide">
                            <tr>
                                <th className="p-4">Session ID</th>
                                <th className="p-4">Created</th>
                                <th className="p-4">Status</th>
                                <th className="p-4">Notes</th>
                                <th className="p-4">Auditor</th>
                                <th className="p-4"></th>
                            </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                            {sessions.map(s => (
                                <tr key={s.id} onClick={() => api.get(`stocktake/${s.id}/`).then(setActiveSession)}
                                    className="hover:bg-slate-50 cursor-pointer transition-colors group">
                                    <td className="p-4 font-mono font-bold text-brand-600">#{s.id}</td>
                                    <td className="p-4 text-slate-500">
                                        {new Date(s.created_at).toLocaleDateString()}
                                        <span
                                            className="text-xs text-slate-400 ml-1">{new Date(s.created_at).toLocaleTimeString([], {
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}</span>
                                    </td>
                                    <td className="p-4"><StatusBadge status={s.status}/></td>
                                    <td className="p-4 text-slate-600 italic max-w-[200px] truncate">{s.note || '-'}</td>
                                    <td className="p-4">
                                        <div className="flex items-center gap-2">
                                            <div
                                                className="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">
                                                {s.created_by_name?.charAt(0)}
                                            </div>
                                            <span className="font-medium text-slate-700">{s.created_by_name}</span>
                                        </div>
                                    </td>
                                    <td className="p-4 text-right">
                                        {s.status === 'in_progress' && (
                                            <button onClick={(e) => deleteSession(s.id, e)}
                                                    className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-all opacity-0 group-hover:opacity-100"
                                                    title="Discard Draft">
                                                <i className="ph ph-trash text-lg"></i>
                                            </button>
                                        )}
                                    </td>
                                </tr>
                            ))}
                            {sessions.length === 0 && (
                                <tr>
                                    <td colSpan="6" className="p-12 text-center text-slate-400 italic">No stocktake
                                        sessions found.
                                    </td>
                                </tr>
                            )}
                            </tbody>
                        </table>
                    </div>
                </Card>
            </div>
        );
    };

    // --- UPDATED MAIN APP COMPONENT ---
    const App = () => {
        const [view, setView] = useState('dashboard');
        const [user, setUser] = useState(null);
        const [storeConfig, setStoreConfig] = useState({store_name: 'Inventro'});
        const [modalParams, setModalParams] = useState(false);
        const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

        useEffect(() => {
            api.get('me/').then(setUser).catch(() => window.location.href = '/login/');
            api.get('settings/').then(setStoreConfig).catch(e => console.error("Config load failed", e));
            const v = localStorage.getItem('view');
            if (v) setView(v);
        }, []);

        const nav = (v, params = false) => {
            setView(v);
            setModalParams(params);
            localStorage.setItem('view', v);
            setMobileMenuOpen(false);
        };

        const NavItem = ({id, icon, label}) => (<button onClick={() => nav(id)}
                                                        className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl mb-1 transition-all ${view === id ? 'bg-brand-600 text-white shadow-lg shadow-brand-900/20' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
            <i className={`ph ${icon} text-xl`}></i><span className="font-medium tracking-wide">{label}</span>
        </button>);

        if (!user) return <div className="h-screen flex items-center justify-center text-slate-400"><i
            className="ph ph-spinner animate-spin text-2xl"></i></div>;

        return (
            <div className="flex h-screen w-full bg-slate-100 font-sans text-slate-900 overflow-hidden">
                {/* Mobile Header */}
                <div
                    className="md:hidden fixed top-0 left-0 right-0 bg-slate-900 text-white p-4 z-40 flex justify-between items-center shadow-md h-16">
                    <div className="font-bold text-lg flex items-center gap-2">
                        <div
                            className="w-8 h-8 rounded-lg bg-brand-600 flex items-center justify-center font-bold text-sm">
                            {storeConfig.store_name.charAt(0)}
                        </div>
                        {storeConfig.store_name}
                    </div>
                    <button onClick={() => setMobileMenuOpen(true)} className="p-2 text-2xl"><i
                        className="ph ph-list"></i></button>
                </div>

                {/* Sidebar Overlay */}
                <div
                    className={`fixed inset-0 z-50 bg-black/50 transition-opacity md:hidden ${mobileMenuOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}
                    onClick={() => setMobileMenuOpen(false)}></div>

                <aside
                    className={`fixed inset-y-0 left-0 z-50 w-72 bg-slate-900 flex flex-col p-6 transition-transform duration-300 md:relative md:translate-x-0 ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                    <button onClick={() => setMobileMenuOpen(false)}
                            className="md:hidden absolute top-4 right-4 text-slate-400 text-2xl"><i
                        className="ph ph-x"></i></button>

                    <div className="flex items-center gap-3 mb-10 px-2 mt-8 md:mt-0">
                        <div
                            className="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-500 to-indigo-600 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-brand-500/20">
                            {storeConfig.store_name.charAt(0)}
                        </div>
                        <div>
                            <span
                                className="text-xl font-bold text-white tracking-tight block leading-none">{storeConfig.store_name}</span>
                            <span
                                className="text-xs text-slate-500 font-mono uppercase">{user.is_manager ? 'Manager' : 'Cashier'}</span>
                        </div>
                    </div>
                    <nav className="flex-grow space-y-1 overflow-y-auto scroller">
                        <NavItem id="pos" icon="ph-shopping-cart" label="POS Terminal"/>
                        <NavItem id="orders" icon="ph-receipt" label="Orders & Refunds"/>
                        <NavItem id="customers" icon="ph-users-three" label="Customers"/>

                        {user.is_manager && (
                            <>
                                <div className="pt-6 pb-2"><span
                                    className="text-xs font-bold uppercase text-slate-600 px-4 tracking-wider">Management</span>
                                </div>
                                <NavItem id="dashboard" icon="ph-chart-pie-slice" label="Overview"/>
                                <NavItem id="sales" icon="ph-currency-dollar"
                                         label="Sales Ledger"/> {/* Added Sales Link */}
                                <NavItem id="inventory" icon="ph-package" label="Inventory"/>
                                <NavItem id="procurement" icon="ph-truck" label="Procurement"/>
                                <NavItem id="stocktake" icon="ph-clipboard-text" label="Stocktake"/>
                                <NavItem id="staff" icon="ph-users" label="Staff"/>
                                <NavItem id="settings" icon="ph-gear" label="Settings"/>
                                <NavItem id="audit" icon="ph-list-magnifying-glass" label="Audit Logs"/>
                            </>
                        )}
                    </nav>
                    <div className="mt-auto pt-6 border-t border-slate-800 relative">
                        {user.is_manager && <div className="mb-4 px-2"><NotificationHub/></div>}
                        <div className="px-4 mb-4 text-slate-500 text-xs">Logged in as <strong
                            className="text-slate-300">{user.username}</strong></div>
                        <a href="/logout/"
                           className="flex items-center gap-3 px-4 py-2 text-red-400 hover:text-red-300 text-sm font-medium transition-colors"><i
                            className="ph ph-sign-out text-lg"></i> Sign Out</a>
                    </div>
                </aside>

                <main className="flex-grow p-4 md:p-8 overflow-hidden h-full relative pt-20 md:pt-8">
                    <ErrorBoundary>
                        {user.is_manager && view === 'dashboard' && <Dashboard onNavigate={nav}/>}
                        {user.is_manager && view === 'sales' && <SalesLedger/>} {/* Added Sales View */}
                        {user.is_manager && view === 'inventory' && <InventoryManager openModalOnLoad={modalParams}/>}
                        {user.is_manager && view === 'procurement' && <Procurement openCreateOnLoad={modalParams}/>}
                        {user.is_manager && view === 'audit' && <AuditLogs/>}
                        {user.is_manager && view === 'staff' && <StaffManager/>}
                        {user.is_manager && view === 'stocktake' && <StocktakeManager/>}
                        {user.is_manager && view === 'settings' &&
                            <SettingsManager onUpdate={(newSettings) => setStoreConfig(newSettings)}/>}
                        {view === 'pos' && <PosTerminal/>}
                        {view === 'orders' && <OrderHistory/>}
                        {view === 'customers' && <CustomerManager/>}
                    </ErrorBoundary>
                </main>
            </div>
        );
    };
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>